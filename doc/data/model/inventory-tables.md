# 商品・在庫ドメイン テーブル仕様

## 1. products（商品マスタ）

### 概要
商品の基本情報を管理するマスタテーブル。

### データ保持ポリシー
- **オンライン保持期間**: 無期限（アクティブ商品）
- **論理削除**: 販売終了商品は論理削除（deleted_at設定）
- **物理削除**: 販売終了後5年経過で削除（税務要件考慮）
- **廃番商品**: product_status = 'DISCONTINUED' として保持

### アーカイブ戦略
- 販売終了後3年経過した商品は読み取り専用のアーカイブDBへ移行
- 過去の注文参照用にproduct_nameはorder_linesにスナップショット保存

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約2KB（テキスト含む） |
| 初期商品数 | 5,000商品 |
| 年間新規商品数 | 3,000商品/年 |
| 3年後の総商品数 | 14,000商品（廃番含む） |
| 3年後の総データ量 | 14,000件 × 2KB ≒ 28MB |

### パフォーマンス考慮事項
- product_code によるユニーク検索を高速化
- category インデックスによるカテゴリ絞り込み最適化

---

## 2. skus（SKU - 在庫管理単位）

### 概要
商品のカラー・サイズ展開ごとのSKUを管理。

### データ保持ポリシー
- **オンライン保持期間**: 無期限（アクティブSKU）
- **論理削除**: 販売終了SKUは論理削除
- **物理削除**: 親商品削除時に連動削除（外部キー制約）

### アーカイブ戦略
- 商品アーカイブ時に連動してアーカイブ

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約1KB |
| SKU展開率 | 1商品あたり平均10SKU（カラー×サイズ） |
| 3年後の総SKU数 | 14,000商品 × 10SKU = 140,000SKU |
| 3年後の総データ量 | 140,000件 × 1KB ≒ 140MB |

### パフォーマンス考慮事項
- sku_code インデックスによる高速検索
- product_id の外部キー参照による商品-SKU連携

---

## 3. inventory_locations（在庫拠点）

### 概要
倉庫・店舗・3PL等の在庫拠点マスタ。

### データ保持ポリシー
- **オンライン保持期間**: 無期限（マスタテーブル）
- **論理削除**: 閉鎖拠点はis_active = FALSEで管理

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.5KB |
| 想定拠点数 | 初期10拠点、3年後20拠点 |
| 総データ量 | 約10KB（非常に小規模） |

---

## 4. inventory_stocks（在庫数）

### 概要
SKU×拠点ごとの在庫数を管理。在庫引当の中核テーブル。

### データ保持ポリシー
- **オンライン保持期間**: 無期限（リアルタイム参照必須）
- **履歴管理**: 在庫変動履歴はinventory_transactionsに記録
- **削除**: SKU廃番時も履歴保持のため論理削除推奨

### アーカイブ戦略
- アーカイブ不要（現在値のみ管理、履歴は別テーブル）

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.5KB |
| 総SKU数 | 140,000SKU |
| 拠点数 | 20拠点 |
| 理論上の最大レコード数 | 140,000 × 20 = 2,800,000件 |
| 実際の保持レコード数 | 約500,000件（すべての拠点に在庫があるわけではない） |
| 総データ量 | 500,000件 × 0.5KB ≒ 250MB |

### パフォーマンス考慮事項
- **楽観ロック**: version カラムで在庫競合を検出
- **インデックス**: sku_id, location_id, available_quantity の複合インデックス
- **Redis キャッシュ**: 在庫参照APIのP99目標達成のため、在庫数をRedisにキャッシュ
- **更新頻度**: 高頻度更新テーブル。デッドロック対策としてトランザクション範囲を最小化

---

## 5. inventory_locks（在庫ロック）

### 概要
注文確定前の在庫確保（カート保持）用のロック管理。

### データ保持ポリシー
- **オンライン保持期間**: アクティブロックのみ（有効期限内）
- **有効期限**: 通常15分〜30分（カート保持時間）
- **自動解放**: 期限切れロックは定期バッチで自動解放（5分ごと）
- **履歴保持**: 解放済みロックは30日間保持後削除（デバッグ用）

### アーカイブ戦略
- アーカイブ不要（短期保持のみ）

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.4KB |
| ピーク時同時カート数 | 10,000カート |
| 平均SKU数/カート | 2.5SKU |
| ピーク時ロック数 | 25,000件 |
| 総データ量 | 約10MB（小規模・短期保持） |

### パフォーマンス考慮事項
- expires_at インデックスによる期限切れロック検索の高速化
- released_at IS NULL 条件でアクティブロックのみ抽出

---

## 6. inventory_transactions（在庫トランザクション履歴）

### 概要
すべての在庫増減を記録するトランザクションログ。

### データ保持ポリシー
- **オンライン保持期間**: 最新1年間
- **ウォーム保持**: 1〜3年（パーティション別管理）
- **アーカイブ**: 3年以上はオブジェクトストレージへ移行
- **法的要件**: 棚卸監査のため最低3年保持

### アーカイブ戦略
- 月次パーティション設計
- 古いパーティションはParquet形式でS3へエクスポート
- 必要に応じてAthena等で過去データをクエリ可能

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.5KB |
| 月間注文数 | 100,000件 |
| 平均SKU数/注文 | 2.5SKU |
| 月間出庫トランザクション | 250,000件 |
| 月間入庫トランザクション | 100,000件 |
| その他（調整・破損等） | 50,000件 |
| 月間総トランザクション数 | 400,000件 |
| 月間データ量 | 400,000件 × 0.5KB ≒ 200MB |
| 年間データ量 | 約2.4GB |
| 3年間（オンライン1年+アーカイブ2年） | 約7.2GB |

### パフォーマンス考慮事項
- パーティショニングによる検索範囲の限定
- sku_id + created_at の複合インデックスで特定SKUの履歴検索を最適化
- reference_type, reference_id インデックスで注文・出荷との紐付け検索を高速化

---

## 在庫整合性保証
- **強整合性**: inventory_stocks の更新はトランザクション内で実行
- **楽観ロック**: version カラムで同時更新を検出、競合時はリトライ
- **在庫負数チェック**: アプリケーション層でavailable_quantity >= 0 を保証
- **監査**: すべての在庫変動をinventory_transactionsに記録し追跡可能に
