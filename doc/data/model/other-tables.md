# プロモーション・決済・返品・監査ドメイン テーブル仕様

## プロモーションドメイン

### 1. promotions（プロモーション）

#### データ保持ポリシー
- **オンライン保持期間**: アクティブプロモーション + 終了後1年間
- **アーカイブ**: 終了後1年経過したプロモーションはアーカイブ
- **削除**: アーカイブ後3年で削除（レポート・監査要件）

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約1.5KB（JSONB含む） |
| 月間プロモーション数 | 50件 |
| 年間プロモーション数 | 600件 |
| 年間データ量 | 約900KB（小規模） |

---

### 2. coupons（クーポン）

#### データ保持ポリシー
- **オンライン保持期間**: 有効期限 + 1年間
- **アーカイブ**: 有効期限切れ後1年経過でアーカイブ

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.5KB |
| 年間発行クーポン数 | 100,000件（キャンペーン配布含む） |
| 年間データ量 | 約50MB |

---

### 3. coupon_usages（クーポン使用履歴）

#### データ保持ポリシー
- **オンライン保持期間**: 最新1年間
- **アーカイブ**: 1年以上経過したレコードはS3へアーカイブ

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.3KB |
| クーポン利用率 | 20%（20,000件/月） |
| 年間使用履歴数 | 240,000件 |
| 年間データ量 | 約72MB |

---

## 出荷・物流ドメイン

### 1. shipments（出荷）

#### データ保持ポリシー
- **オンライン保持期間**: 最新1年間
- **アーカイブ**: 配送完了後1年経過でアーカイブ
- **法的要件**: 配送証明として3年保持

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約1.2KB（配送先情報含む） |
| 月間出荷数 | 100,000件（注文数と同等） |
| 年間出荷数 | 1,200,000件 |
| 年間データ量 | 約1.4GB |

---

### 2. shipment_trackings（配送追跡）

#### データ保持ポリシー
- **オンライン保持期間**: 配送完了後90日間
- **アーカイブ**: 90日経過後はS3へアーカイブ
- **削除**: アーカイブ後1年で削除

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.5KB |
| 平均トラッキングイベント数/出荷 | 7件（ラベル作成→集荷→中継→配達中→完了等） |
| 月間イベント数 | 100,000出荷 × 7件 = 700,000件 |
| 年間データ量 | 700,000件/月 × 0.5KB × 12ヶ月 ≒ 4.2GB |

---

## 返品・交換ドメイン

### 1. returns（返品）

#### データ保持ポリシー
- **オンライン保持期間**: 最新3年間（返品履歴参照要件）
- **アーカイブ**: 3年以上経過したレコードはアーカイブ
- **法的要件**: 会計監査のため5年保持

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約1.5KB（JSONB画像URL含む） |
| 返品率 | 5%（月間5,000件） |
| 年間返品数 | 60,000件 |
| 年間データ量 | 約90MB |

---

### 2. exchanges（交換）

#### データ保持ポリシー
- 返品テーブルと同等

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.8KB |
| 交換率 | 返品の30%（月間1,500件） |
| 年間交換数 | 18,000件 |
| 年間データ量 | 約14MB |

---

## 決済ドメイン

### 1. payments（支払い）

#### データ保持ポリシー
- **オンライン保持期間**: 最新3年間（会計・税務要件）
- **アーカイブ**: 3年経過後はアーカイブ
- **法的要件**: 7年保持（税務要件）
- **PCI-DSS**: カード情報は保存せず、トークンのみ保持

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約1KB（JSONB含む） |
| 月間決済数 | 100,000件（注文数と同等） |
| 年間決済数 | 1,200,000件 |
| 年間データ量 | 約1.2GB |

---

### 2. payment_transactions（決済トランザクション）

#### データ保持ポリシー
- **オンライン保持期間**: 最新1年間
- **アーカイブ**: 1年経過後はアーカイブ
- **法的要件**: 決済履歴として7年保持

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.6KB |
| 平均トランザクション数/決済 | 2件（認可+確定、または認可+失敗等） |
| 年間トランザクション数 | 2,400,000件 |
| 年間データ量 | 約1.4GB |

---

## 監査ログドメイン

### 1. audit_logs（操作監査ログ）

#### データ保持ポリシー
- **オンライン保持期間**: 最新1年間
- **アーカイブ**: 1年経過後はS3へアーカイブ
- **法的要件**: 最低1年保持必須、推奨3〜5年

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約1.5KB（JSONB変更履歴含む） |
| 月間監査ログ数 | 500,000件（主要操作のみ） |
| 年間監査ログ数 | 6,000,000件 |
| 年間データ量 | 約9GB |
| 3年後の総データ量 | オンライン1年: 9GB + アーカイブ2年: 18GB = 27GB |

#### パフォーマンス考慮事項
- 月次パーティション設計必須
- entity_type + entity_id インデックスで特定エンティティの変更履歴を高速検索
- request_id インデックスでリクエストトレーシング対応

---

### 2. system_events（システムイベントログ）

#### データ保持ポリシー
- **オンライン保持期間**: 最新6ヶ月間
- **アーカイブ**: 6ヶ月経過後はS3へアーカイブ
- **削除**: アーカイブ後1年で削除（運用監視目的のため短期保持）

#### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約1KB（JSONB含む） |
| 日次イベント数 | 10,000件（エラー・警告・INFO含む） |
| 年間イベント数 | 3,650,000件 |
| 年間データ量 | 約3.6GB |

#### パフォーマンス考慮事項
- severity インデックスでCRITICAL/ERRORイベントを高速抽出
- acknowledged = FALSE インデックスで未対応アラートを即座に検索
- 月次パーティション設計

---

## 全体データサイズサマリー（3年後想定）

| ドメイン | オンライン | アーカイブ | 合計 |
|---------|-----------|-----------|------|
| ユーザー・認証 | 0.5GB | 1GB | 1.5GB |
| 商品・在庫 | 0.4GB | 15GB | 15.4GB |
| 注文 | 4.2GB | 8.4GB | 12.6GB |
| プロモーション | 0.1GB | 0.2GB | 0.3GB |
| 出荷・物流 | 1.5GB | 4GB | 5.5GB |
| 返品・交換 | 0.3GB | 0.5GB | 0.8GB |
| 決済 | 2.6GB | 5.2GB | 7.8GB |
| 監査ログ | 12.6GB | 25GB | 37.6GB |
| **総計** | **約22GB** | **約60GB** | **約82GB** |

### 運用推奨事項
- パーティショニングは必須（月次または四半期）
- 古いパーティションの定期的なアーカイブ自動化
- S3アーカイブはParquet形式で圧縮（70%圧縮率想定）
- Athena/BigQuery等で過去データも分析可能に
