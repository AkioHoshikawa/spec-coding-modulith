# 注文ドメイン テーブル仕様

## 1. carts（カート）

### 概要
ショッピングカートを管理。ログイン前後で統合可能。

### データ保持ポリシー
- **オンライン保持期間**: 有効期限内（通常24〜48時間）
- **有効期限切れ**: cart_status = 'ABANDONED' に変更
- **削除**: 放棄カート（ABANDONED）は90日後に削除
- **注文確定済み**: cart_status = 'CONVERTED' として30日間保持後削除

### アーカイブ戦略
- アーカイブ不要（短期保持・定期削除）
- 放棄カート分析が必要な場合は削除前に集計データをエクスポート

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.3KB |
| 日次カート作成数 | 5,000件 |
| 保持期間（平均） | 7日間 |
| 想定レコード数 | 35,000件程度 |
| 総データ量 | 約10MB（小規模） |

---

## 2. cart_items（カート明細）

### 概要
カート内の商品明細を管理。

### データ保持ポリシー
- **オンライン保持期間**: 親カートの有効期限に準ずる
- **削除**: 親カート削除時に連動削除

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.3KB |
| 平均SKU数/カート | 2.5SKU |
| 想定レコード数 | 35,000カート × 2.5SKU = 87,500件 |
| 総データ量 | 約26MB（小規模） |

---

## 3. orders（注文）

### 概要
注文ヘッダー情報を管理。注文全体の状態を保持。

### データ保持ポリシー
- **オンライン保持期間**: 最新1年間
- **ウォーム保持**: 1〜3年（完了注文はパーティション別管理）
- **アーカイブ**: 3年以上はオブジェクトストレージへ移行
- **法的要件**: 税務・会計要件により最低7年保持（アーカイブ含む）
- **個人情報**: 配送先情報はGDPR等に基づきユーザー削除要求時にマスキング

### アーカイブ戦略
- 月次パーティション設計（ordered_atベース）
- 完了後1年経過した注文は圧縮してS3へエクスポート
- Parquet形式で保存し、Athena等で分析可能に
- 個人情報はアーカイブ前にマスキング処理

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約1.5KB（配送先情報含む） |
| 月間注文数 | 100,000件 |
| 年間注文数 | 1,200,000件 |
| 年間データ量 | 1,200,000件 × 1.5KB ≒ 1.8GB |
| 3年後の総データ量 | オンライン1年: 1.8GB + アーカイブ2年: 3.6GB = 5.4GB |

### パフォーマンス考慮事項
- order_number インデックスによる顧客向け注文検索の高速化
- user_id + ordered_at 複合インデックスでユーザー注文履歴検索を最適化
- order_status インデックスで処理中注文の抽出を高速化
- パーティショニングにより検索範囲を限定し、大量データでもP99 < 2秒を達成

---

## 4. order_lines（注文明細）

### 概要
注文のSKUごとの明細情報を管理。

### データ保持ポリシー
- **オンライン保持期間**: 親注文の保持ポリシーに準ずる
- **アーカイブ**: 親注文と同時にアーカイブ

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.8KB（商品情報スナップショット含む） |
| 平均SKU数/注文 | 2.5SKU |
| 年間明細数 | 1,200,000注文 × 2.5SKU = 3,000,000件 |
| 年間データ量 | 3,000,000件 × 0.8KB ≒ 2.4GB |
| 3年後の総データ量 | オンライン1年: 2.4GB + アーカイブ2年: 4.8GB = 7.2GB |

### パフォーマンス考慮事項
- order_id インデックスで特定注文の明細取得を高速化
- sku_id インデックスで商品別売上分析を最適化
- product_name等のスナップショット保存により、商品マスタ変更の影響を受けない

---

## 5. order_status_history（注文ステータス履歴）

### 概要
注文ステータスの変更履歴を記録。監査とトラッキングに使用。

### データ保持ポリシー
- **オンライン保持期間**: 最新1年間
- **ウォーム保持**: 1〜3年
- **アーカイブ**: 3年以上はオブジェクトストレージへ移行
- **監査要件**: 最低1年保持必須

### アーカイブ戦略
- 月次パーティション設計
- 親注文のアーカイブと連動してアーカイブ

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.4KB |
| 平均ステータス変更回数/注文 | 5回（PENDING→CONFIRMED→ALLOCATED→SHIPPED→DELIVERED） |
| 年間レコード数 | 1,200,000注文 × 5回 = 6,000,000件 |
| 年間データ量 | 6,000,000件 × 0.4KB ≒ 2.4GB |
| 3年後の総データ量 | オンライン1年: 2.4GB + アーカイブ2年: 4.8GB = 7.2GB |

### パフォーマンス考慮事項
- order_id + changed_at 複合インデックスで注文ステータス履歴取得を高速化
- to_status インデックスで特定ステータスへの遷移分析を最適化

---

## 注文処理フロー
1. **カート作成**: carts, cart_items にデータ保存
2. **注文確定**: 
   - orders, order_lines 作成
   - inventory_locks で在庫ロック
   - cart_status = 'CONVERTED' に変更
3. **在庫引当**: 
   - inventory_stocks の available_quantity 減少
   - inventory_transactions に出庫記録
   - order_status = 'ALLOCATED' に変更
4. **出荷**: 
   - shipments 作成
   - order_status = 'SHIPPED' に変更
5. **配送完了**: 
   - order_status = 'COMPLETED' に変更

## パフォーマンス目標
- 注文確定API（在庫引当含む）P99: 2秒以内
- 注文履歴取得API P95: 500ms以内
- 管理画面注文一覧表示 P95: 1秒以内

## データ整合性
- orders と order_lines はトランザクション境界内で作成
- 在庫引当失敗時は注文ステータスを 'FAILED' に設定しロールバック
- 楽観ロック（version）による同時更新制御
