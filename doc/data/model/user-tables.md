# ユーザー・認証ドメイン テーブル仕様

## 1. users（ユーザーアカウント）

### 概要
ユーザーアカウントの基本情報を管理するマスタテーブル。

### データ保持ポリシー
- **オンライン保持期間**: 無期限（アクティブユーザー）
- **論理削除期間**: 退会後3年間は論理削除として保持（deleted_atに日時記録）
- **物理削除**: 退会後3年経過で個人情報を匿名化または削除
- **GDPR/個人情報保護対応**: ユーザーからの削除要求に即座に対応可能

### アーカイブ戦略
- 退会後1年経過したユーザー: コールドストレージ（S3等）へアーカイブ
- アーカイブ時は個人情報をマスキング（email, phone_number等を匿名化）
- 注文履歴参照のため、user_idのみ保持

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約1.5KB（インデックス含む2KB） |
| 想定総ユーザー数 | 初年度: 50,000人、3年後: 200,000人 |
| 年間増加数 | 50,000人/年 |
| 3年後の総データ量 | 200,000件 × 2KB ≒ 400MB |
| 年間増加量 | 約100MB/年 |

### パフォーマンス考慮事項
- email カラムのユニークインデックスによる高速ログイン検索
- user_status インデックスによるアクティブユーザー抽出の最適化
- version カラムによる楽観ロック（プロフィール更新の競合制御）

---

## 2. user_addresses（配送先住所）

### 概要
ユーザーの配送先住所を管理。1ユーザーにつき複数住所登録可能。

### データ保持ポリシー
- **オンライン保持期間**: ユーザーアクティブ期間中は無期限
- **論理削除**: ユーザーによる住所削除後も30日間は論理削除として保持（誤削除対策）
- **物理削除**: ユーザー退会後3年で関連住所も削除

### アーカイブ戦略
- ユーザー退会時に関連住所も併せてアーカイブ
- 過去の注文では配送先住所はordersテーブルにスナップショットとして保存

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.8KB（インデックス含む1KB） |
| 平均住所登録数 | 2.5件/ユーザー |
| 3年後の総レコード数 | 200,000人 × 2.5件 = 500,000件 |
| 3年後の総データ量 | 500,000件 × 1KB ≒ 500MB |

---

## 3. user_sessions（セッション管理）

### 概要
アクティブなユーザーセッションとトークンを管理。

### データ保持ポリシー
- **オンライン保持期間**: アクティブセッションのみ（短寿命）
- **有効期限**: アクセストークン15分、リフレッシュトークン7日（設定による）
- **自動削除**: 有効期限切れセッションは定期バッチで削除（日次）
- **ログアウト時**: revoked_atに失効日時を記録し即座に無効化

### アーカイブ戦略
- アーカイブ不要（短期保持のみ）
- セキュリティ監査が必要な場合、user_auth_eventsに記録

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.5KB |
| 同時アクティブユーザー数 | 5,000人（ピーク時） |
| 平均セッション数/ユーザー | 2件（PC・スマホ等） |
| 想定レコード数 | 10,000件程度 |
| 総データ量 | 約5MB（小規模） |

### パフォーマンス考慮事項
- access_token_hash インデックスによる高速検証
- Redis等のキャッシュにセッション情報を保持し、DBアクセスを最小化
- 認証P99目標200ms達成のため、セッション検証は極力軽量化

---

## 4. user_auth_events（認証イベント監査ログ）

### 概要
すべての認証関連イベント（ログイン成功/失敗、パスワード変更等）を記録。

### データ保持ポリシー
- **オンライン保持期間**: 最新1年間
- **ウォーム保持**: 1〜3年（圧縮・パーティション別管理）
- **アーカイブ**: 3年以上はオブジェクトストレージへ移行
- **法的要件**: 監査要求に備え最低1年保持必須

### アーカイブ戦略
- 月次パーティション設計により古いパーティションを効率的にアーカイブ
- Parquet形式でS3へエクスポート（圧縮率高・クエリ可能）

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約1KB |
| 月間ログイン回数 | 200,000回（1ユーザー平均月10回） |
| その他イベント | 50,000回/月（パスワード変更等） |
| 月間レコード数 | 250,000件 |
| 年間レコード数 | 3,000,000件 |
| 年間データ量 | 約3GB/年 |
| 3年後の総データ量 | 約9GB（オンライン1年 + アーカイブ2年） |

### パフォーマンス考慮事項
- パーティショニングにより検索範囲を限定
- 不正ログイン検知のため、ip_address + created_at の複合インデックス
- アラート用にevent_type別の集計クエリを最適化

---

## 5. password_reset_tokens（パスワードリセットトークン）

### 概要
パスワードリセット用のワンタイムトークンを管理。

### データ保持ポリシー
- **オンライン保持期間**: 有効期限（通常1時間）+ 使用済み後30日
- **自動削除**: 有効期限切れ・使用済みトークンは定期バッチで削除（日次）
- **セキュリティ**: トークンはハッシュ化して保存

### アーカイブ戦略
- アーカイブ不要（短期保持・自動削除）

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.3KB |
| 月間リセット要求数 | 5,000件 |
| 保持期間 | 最大30日 |
| 想定レコード数 | 5,000件程度 |
| 総データ量 | 約1.5MB（非常に小規模） |

---

## 6. email_verification_tokens（メール確認トークン）

### 概要
メールアドレス確認用のトークンを管理。

### データ保持ポリシー
- **オンライン保持期間**: 有効期限（通常24時間）+ 確認済み後30日
- **自動削除**: 期限切れ・確認済みトークンは定期削除

### データサイズ見積もり
| 項目 | 値 |
|------|-----|
| 1レコードサイズ | 約0.3KB |
| 月間新規登録数 | 4,000件 |
| 保持期間 | 最大30日 |
| 想定レコード数 | 4,000件程度 |
| 総データ量 | 約1.2MB（非常に小規模） |

---

## セキュリティ要件
- パスワードはArgon2またはPBKDF2でハッシュ化（平文保存厳禁）
- トークンは必ずハッシュ化して保存（SHA-256等）
- 個人情報カラム（email, phone_number, name等）は暗号化も検討
- アクセスログは必ずIP・UserAgentを記録し異常検知に活用
