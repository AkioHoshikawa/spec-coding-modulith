# ユーザーストーリー：カート管理と注文確定

## 基本情報

| 項目 | 内容 |
|------|------|
| **ID** | US-003 |
| **タイトル** | カート管理と注文確定機能の実装 |
| **ステータス** | Draft |
| **優先度** | High |
| **見積もり** | 13ストーリーポイント |
| **担当者** | 未割当 |
| **作成日** | 2025-11-11 |
| **更新日** | 2025-11-11 |

## ユーザーストーリー

**As a** ECサイトのユーザー  
**I want** 商品をカートに追加し、まとめて注文を確定できる  
**So that** 複数の商品を一度に購入し、効率的に買い物ができる

### 日本語記述

ECサイトのユーザーとして、効率的に買い物をするために、商品をカートに追加し、まとめて注文確定できる機能が必要である。

## 背景・目的

### ビジネス背景
ファッションECでは、顧客が複数の商品を比較検討しながら購入を決定するため、カート機能は必須である。また、注文確定時に在庫を即座にロックすることで、セールやタイムセール時のオーバーセルを防ぐ必要がある。プロジェクト概要では、ピーク時（秒間数千リクエスト）でも在庫整合性を保つことが求められている。

### ユーザーニーズ
- 商品を選択しながらカートに追加し、後でまとめて購入したい
- カート内の商品数量を変更したり、削除したりしたい
- 複数の配送先を指定して注文したい（ギフト送付など）
- 注文確定時に在庫切れがないか確認したい
- 支払い方法を選択して安全に決済したい

### 現状の課題
- ピーク時の在庫競合によるオーバーセルリスク
- 複数ユーザーが同時に同じSKUを注文する際の整合性確保
- カート保持期限の管理（長期間放置されたカートの扱い）

## 受入基準（Acceptance Criteria）

### 機能要件

#### AC-1: カートへ商品追加
**Given** ユーザーが商品詳細ページを閲覧している  
**When** サイズ・カラーを選択して「カートに追加」ボタンを押下する  
**Then** 選択したSKUがカートに追加され、カート件数が更新される

**詳細説明:**
- ログインユーザーの場合、カートはサーバー側で永続化される
- 未ログインユーザーの場合、カートはローカルストレージ/セッションで管理される
- 同じSKUを追加した場合は数量が加算される
- 在庫数を超える数量は追加できない（即座にバリデーション）
- カート追加時に軽量な在庫チェックを実施（確定時に再度チェック）

#### AC-2: カート内容の表示と編集
**Given** ユーザーがカートページにアクセスする  
**When** カート内容が表示される  
**Then** 商品画像、商品名、SKU情報、単価、数量、小計が表示される

**詳細説明:**
- 数量変更（+/-ボタンまたは直接入力）が可能
- 削除ボタンで個別に商品を削除可能
- 在庫不足の商品は警告表示される
- プロモーション適用後の価格が表示される
- 送料計算のプレビューが表示される

#### AC-3: 配送先情報の設定
**Given** ユーザーがカートから「購入手続きへ進む」を選択する  
**When** 配送先情報入力画面が表示される  
**Then** 登録済み住所の選択、または新規住所入力が可能

**詳細説明:**
- 複数配送先の指定が可能（商品ごとに配送先を分ける）
- ギフトオプション（のし、メッセージカード）の選択が可能
- 配送希望日時の指定が可能
- 新規住所は次回以降のために保存するか選択できる

#### AC-4: 注文確定と在庫ロック
**Given** ユーザーが配送先と支払い方法を設定済み  
**When** 「注文を確定する」ボタンを押下する  
**Then** 在庫が即座にロックされ、注文が確定する

**詳細説明:**
- 在庫引当は原子操作で実施（楽観ロックまたは悲観ロック）
- 在庫不足の場合はエラーメッセージとともに注文が失敗
- 在庫ロック成功後、決済処理を実施
- 決済失敗時は在庫ロックを自動的に解放（ロールバック）
- 注文確定時にユニークな注文IDが発行される
- 注文確定完了メールが送信される

#### AC-5: 注文確定のパフォーマンス要件
**Given** ピーク時に複数ユーザーが同時に注文確定を実施  
**When** 秒間1000リクエストの負荷がかかる  
**Then** P99レスポンスタイム2秒以内で注文が確定する

**詳細説明:**
- 在庫ロック処理は分散ロック（Redisなど）を活用
- データベーストランザクションは最小限に抑える
- 在庫数の更新はアトミックに実施
- 楽観ロックによるリトライロジックを実装

#### AC-6: カート保持期限管理
**Given** ユーザーがカートに商品を追加したまま放置  
**When** 7日間経過する  
**Then** カートは自動的にクリアされる

**詳細説明:**
- ログインユーザーのカートは7日間保持
- 未ログインユーザーのカートはセッション終了まで保持
- カート保持期限が近い場合、リマインドメールを送信（オプション）

### 非機能要件

#### パフォーマンス
- [ ] カート追加APIのP95レスポンスタイム: 100ms以内
- [ ] 注文確定APIのP99レスポンスタイム: 2秒以内
- [ ] ピーク時処理能力: 秒間1000注文確定リクエスト
- [ ] 在庫ロック処理のタイムアウト: 5秒

#### セキュリティ
- [ ] 認証必須（JWT/セッショントークン検証）
- [ ] CSRF対策実装
- [ ] 価格改ざん防止（サーバー側で価格再計算）
- [ ] SQLインジェクション対策

#### 可用性
- [ ] 注文確定処理のSLA: 99.9%
- [ ] データベース障害時のグレースフルデグレード

#### 保守性
- [ ] 注文確定の全プロセスを監査ログに記録
- [ ] 在庫ロック失敗時のアラート
- [ ] カート放棄率のメトリクス取得

## UI/UX要件

### 画面遷移
```
[商品詳細] → [カートに追加] → [カート画面] → [配送先入力] → [支払い方法選択] → [注文確認] → [注文完了]
     ↓                              ↓
[カート更新]                    [カートに戻る]
```

### ワイヤーフレーム
- **カート画面**: 商品一覧（画像、名称、SKU、単価、数量、小計）、合計金額、クーポン入力欄
- **配送先入力画面**: 住所選択ドロップダウン、新規住所入力フォーム、配送日時選択
- **注文確認画面**: 注文内容サマリー、配送先、支払い方法、合計金額

### インタラクション
- カート追加時にトーストまたはモーダルで確認メッセージ表示
- 数量変更時は即座にAPIを呼び出し、小計を更新
- 在庫不足時は該当商品をハイライト表示
- 注文確定時はローディングスピナー表示（二重送信防止）
- 注文完了後は確認画面を表示し、注文IDとステータスを表示

## 技術要件

### API仕様

#### エンドポイント: カートに商品追加
- **メソッド:** POST
- **パス:** `/api/v1/cart/items`
- **認証:** Required（JWT）

**リクエスト:**
```json
{
  "skuId": "sku_ABC123",
  "quantity": 2
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "cartId": "cart_123456",
    "items": [
      {
        "cartItemId": "item_001",
        "skuId": "sku_ABC123",
        "productName": "コットンTシャツ",
        "size": "M",
        "color": "ホワイト",
        "quantity": 2,
        "unitPrice": 2980,
        "subtotal": 5960
      }
    ],
    "totalItems": 2,
    "totalAmount": 5960
  }
}
```

#### エンドポイント: 注文確定
- **メソッド:** POST
- **パス:** `/api/v1/orders`
- **認証:** Required（JWT）

**リクエスト:**
```json
{
  "cartId": "cart_123456",
  "shippingAddress": {
    "addressId": "addr_789",
    "recipientName": "山田太郎",
    "postalCode": "100-0001",
    "prefecture": "東京都",
    "city": "千代田区",
    "addressLine1": "千代田1-1-1",
    "phoneNumber": "090-1234-5678"
  },
  "paymentMethod": {
    "type": "credit_card",
    "paymentToken": "tok_visa_1234"
  },
  "giftOptions": {
    "isGift": false
  }
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "orderId": "ord_202511110001",
    "orderNumber": "ECF-20251111-0001",
    "status": "confirmed",
    "totalAmount": 5960,
    "estimatedDeliveryDate": "2025-11-15",
    "createdAt": "2025-11-11T10:30:00Z"
  }
}
```

**レスポンス（在庫不足エラー）:**
```json
{
  "status": "error",
  "error": {
    "code": "INSUFFICIENT_INVENTORY",
    "message": "在庫不足のため注文を確定できません",
    "details": [
      {
        "skuId": "sku_ABC123",
        "requestedQuantity": 2,
        "availableQuantity": 1
      }
    ]
  }
}
```

### データモデル

#### エンティティ: Cart
```
Cart:
- cartId: UUID (主キー)
- userId: UUID (外部キー -> User)
- status: Enum (active, abandoned, converted)
- expiresAt: Timestamp
- createdAt: Timestamp
- updatedAt: Timestamp
```

#### エンティティ: CartItem
```
CartItem:
- cartItemId: UUID (主キー)
- cartId: UUID (外部キー -> Cart)
- skuId: UUID (外部キー -> SKU)
- quantity: Integer
- unitPrice: Decimal (カート追加時の価格をスナップショット)
- createdAt: Timestamp
- updatedAt: Timestamp
```

#### エンティティ: Order
```
Order:
- orderId: UUID (主キー)
- orderNumber: String (一意、ビジネスキー)
- userId: UUID (外部キー -> User)
- status: Enum (confirmed, paid, shipped, delivered, cancelled)
- totalAmount: Decimal
- shippingFee: Decimal
- taxAmount: Decimal
- discountAmount: Decimal
- paymentMethod: String
- createdAt: Timestamp
- updatedAt: Timestamp
```

#### エンティティ: OrderLine
```
OrderLine:
- orderLineId: UUID (主キー)
- orderId: UUID (外部キー -> Order)
- skuId: UUID (外部キー -> SKU)
- quantity: Integer
- unitPrice: Decimal
- subtotal: Decimal
- inventoryLockId: UUID (在庫ロックトランザクションの追跡用)
- createdAt: Timestamp
```

#### エンティティ: ShippingAddress
```
ShippingAddress:
- addressId: UUID (主キー)
- orderId: UUID (外部キー -> Order)
- recipientName: String
- postalCode: String
- prefecture: String
- city: String
- addressLine1: String
- addressLine2: String (オプション)
- phoneNumber: String
- deliveryDate: Date (希望配送日)
- deliveryTimeSlot: String (午前/午後/指定なし)
- giftMessage: Text (オプション)
```

#### リレーションシップ
- User 1:N Cart
- Cart 1:N CartItem
- User 1:N Order
- Order 1:N OrderLine
- Order 1:1 ShippingAddress

### ビジネスルール参照
- [BR-INV-001: 注文確定時に在庫を即時ロックする](../business-rule/BR-INV-001_注文確定時に在庫を即時ロックする.md)
- BR-CART-001: カート保持期限は7日間
- BR-ORDER-001: 注文確定時の価格はカート追加時点ではなく確定時点の価格を適用
- BR-PAYMENT-001: 決済失敗時は在庫ロックを即座に解放

## 依存関係

### 前提条件
- [ ] ユーザー認証機能が実装済み（US-002）
- [ ] 商品・SKUマスタが登録済み
- [ ] 在庫管理システムが実装済み
- [ ] 決済プロバイダーとの連携が完了
- [ ] Redis（分散ロック用）が利用可能

### 依存するストーリー
- US-002: ユーザー登録とログイン
- US-004: 在庫管理と在庫ロック機能
- US-005: プロモーション・クーポン適用機能

### ブロッカー
- 決済プロバイダーAPIのサンドボックス環境セットアップ
- 在庫ロック戦略の技術選定（楽観ロック vs 悲観ロック vs 分散ロック）

## テスト戦略

### 単体テスト
- [ ] カート追加ロジックのバリデーション
- [ ] 価格計算ロジック（税込、送料、割引）
- [ ] 在庫引当ロジック
- [ ] カバレッジ目標: 85%以上

### 統合テスト
- [ ] カート追加から注文確定までのフロー
- [ ] 在庫不足時のエラーハンドリング
- [ ] 決済失敗時のロールバック
- [ ] トランザクション整合性の検証

### E2Eテスト
- [ ] ユーザーが商品をカートに追加→注文確定→完了メール受信まで
- [ ] 複数配送先を指定した注文
- [ ] クーポン適用した注文
- [ ] 在庫不足での注文失敗シナリオ

### 性能テスト
- [ ] 同時1000ユーザーがカート追加（P95 < 100ms）
- [ ] 同時500ユーザーが注文確定（P99 < 2秒）
- [ ] 同一SKUへの1000並列注文でオーバーセルが発生しないこと
- [ ] 在庫ロック競合時のリトライ成功率

## 実装計画

### タスク分解
1. [ ] データモデル設計とマイグレーション
   - 見積もり: 6時間
   - 担当: バックエンドエンジニア
2. [ ] カート追加API実装
   - 見積もり: 8時間
   - 担当: バックエンドエンジニア
3. [ ] カート参照・更新・削除API実装
   - 見積もり: 6時間
   - 担当: バックエンドエンジニア
4. [ ] 注文確定API実装（在庫ロックロジック含む）
   - 見積もり: 16時間
   - 担当: バックエンドエンジニア
5. [ ] 決済連携実装（外部API呼び出し）
   - 見積もり: 10時間
   - 担当: バックエンドエンジニア
6. [ ] カート画面UI実装
   - 見積もり: 12時間
   - 担当: フロントエンドエンジニア
7. [ ] 配送先入力・注文確認画面UI実装
   - 見積もり: 10時間
   - 担当: フロントエンドエンジニア
8. [ ] テスト実装（単体・統合・E2E・性能）
   - 見積もり: 16時間
   - 担当: QAエンジニア

### 技術的考慮事項
- 在庫ロックは分散ロック（Redlock）と楽観ロックの併用を検討
- 注文確定トランザクションは長時間保持せず、Sagaパターンで補償トランザクション実装
- カートはRedisにキャッシュし、DBへの書き込みは非同期で実施
- 価格計算はサーバー側で必ず再計算（クライアントからの価格は信頼しない）
- 在庫引当失敗時のリトライロジック（Exponential Backoff）

### リスクと対策
| リスク | 影響度 | 対策 |
|--------|--------|------|
| ピーク時の在庫競合によるオーバーセル | High | 分散ロック + 楽観ロック併用、リトライロジック実装 |
| 決済API障害 | High | サーキットブレーカー実装、タイムアウト設定、リトライ制限 |
| データベースデッドロック | Medium | トランザクションスコープ最小化、ロック順序の統一 |
| カート放棄による在庫拘束 | Low | カート保持期限管理、定期的なクリーンアップジョブ |

## 完了の定義（Definition of Done）

- [ ] コードが実装され、レビューが完了している
- [ ] 全ての受入基準が満たされている
- [ ] 単体テストが実装され、全てパスしている（カバレッジ85%以上）
- [ ] 統合テストが実装され、全てパスしている
- [ ] E2Eテストが実装され、全てパスしている
- [ ] 性能テストが完了し、SLA基準を満たしている
- [ ] セキュリティレビューが完了している
- [ ] API仕様書が更新されている
- [ ] ステージング環境でのテストが完了している
- [ ] プロダクトオーナーによる受入テストが完了している
- [ ] 監視・アラート設定が完了している

## 参考資料

### 関連ドキュメント
- [プロジェクト概要](../project-overview.md)
- [在庫管理テーブル定義](../data/schema/inventory.sql)
- [注文テーブル定義](../data/schema/order.sql)
- [BR-001: 在庫引当とロック機構](../business-rule/BR-001_在庫引当とロック機構.md)

### 外部参照
- [Redlock分散ロックアルゴリズム](https://redis.io/topics/distlock)
- [Sagaパターン](https://microservices.io/patterns/data/saga.html)
- [楽観ロック vs 悲観ロック](https://en.wikipedia.org/wiki/Optimistic_concurrency_control)

## 備考・コメント

### 設計上の決定事項
- 在庫ロックは注文確定時のみ実施（カート追加時はソフトチェックのみ）
- 注文確定はべき等性を保証（同一リクエストの重複実行を防止）
- 価格はスナップショット方式（注文時点の価格を記録）

### 技術的負債
- カート同期（複数デバイス間でのカート共有）は将来対応
- ワンクリック購入機能は将来対応
- 定期購入（サブスクリプション）機能は将来対応

### 将来の拡張性
- 複数決済手段の追加（コンビニ決済、キャリア決済、後払い等）
- Apple Pay、Google Pay対応
- カート共有機能（友人と一緒に購入）
- 予約購入（発売前商品の事前注文）

---

## 変更履歴

| 日付 | 変更者 | 変更内容 |
|------|--------|----------|
| 2025-11-11 | AI Assistant | 初版作成 |
