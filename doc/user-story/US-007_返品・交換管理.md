# ユーザーストーリー：返品・交換管理

## 基本情報

| 項目 | 内容 |
|------|------|
| **ID** | US-007 |
| **タイトル** | 返品・交換申請と処理ワークフローの実装 |
| **ステータス** | Draft |
| **優先度** | Medium |
| **見積もり** | 10ストーリーポイント |
| **担当者** | 未割当 |
| **作成日** | 2025-11-11 |
| **更新日** | 2025-11-11 |

## ユーザーストーリー

**As a** 購入者  
**I want** 商品が気に入らなかった場合やサイズが合わなかった場合に返品・交換を簡単に申請できる  
**So that** 安心してオンラインで購入できる

### 日本語記述

購入者として、安心してオンラインで商品を購入するために、商品が気に入らなかった場合やサイズが合わなかった場合に返品・交換を簡単に申請できる機能が必要である。

## 背景・目的

### ビジネス背景
ファッションECでは、試着できないことが購入の障壁となるため、柔軟な返品・交換ポリシーが顧客満足度向上と売上増加の鍵となる。プロジェクト概要では「返品・交換申請ワークフロー」が明記されており、顧客が安心して購入できる環境を提供する必要がある。

### ユーザーニーズ
- **購入者**: サイズ違いや色違いで簡単に交換したい、不良品は返金してほしい
- **カスタマーサポート**: 返品・交換申請を効率的に処理したい
- **倉庫**: 返品商品の受入と検品を記録したい
- **運営**: 返品率を分析し、商品改善につなげたい

### 現状の課題
- 返品・交換申請が電話やメールでの手動対応で時間がかかる
- 返品理由の記録が不十分で改善につながらない
- 返品商品の在庫復元プロセスが曖昧
- 返金処理の遅延が顧客不満につながる

## 受入基準（Acceptance Criteria）

### 機能要件

#### AC-1: 返品申請
**Given** 商品を受け取った顧客がマイページにアクセス  
**When** 注文履歴から「返品申請」を選択し、理由を入力して送信  
**Then** 返品申請が登録され、ステータスが「返品申請中」になる

**詳細説明:**
- 返品可能期間は商品到着後14日以内（設定可能）
- 返品理由を選択（サイズ違い、イメージ違い、不良品、その他）
- 返品方法の選択（集荷依頼、自己発送）
- 返品申請受付メールを自動送信
- 返品ラベル（PDF）を発行

#### AC-2: 交換申請
**Given** 商品のサイズや色を変更したい顧客  
**When** 注文履歴から「交換申請」を選択し、希望商品を指定  
**Then** 交換申請が登録され、交換商品の在庫が確認される

**詳細説明:**
- 交換可能な商品一覧を表示（同一商品の別サイズ・色）
- 交換商品の在庫有無を即座に確認
- 在庫がある場合は交換承認、ない場合は返品のみ提案
- 差額がある場合は追加決済または返金処理
- 交換申請受付メールを自動送信

#### AC-3: 返品商品の受入・検品
**Given** 返品商品が倉庫に到着  
**When** 倉庫担当者が返品商品を受け入れて検品  
**Then** 検品結果を記録し、ステータスを「返品確認済」に更新

**詳細説明:**
- 返品商品のスキャン（バーコード/QRコード）
- 商品状態の確認（未使用、使用済み、破損）
- 検品結果の記録（承認/拒否）
- 承認の場合は在庫に復元、拒否の場合は顧客に連絡
- 検品完了メールを顧客に送信

#### AC-4: 返金処理
**Given** 返品が承認されている  
**When** 返金処理を実行  
**Then** 決済方法に応じて返金が処理され、顧客に通知される

**詳細説明:**
- クレジットカード決済の場合はカード会社経由で返金
- 銀行振込の場合は振込先口座情報を取得して振込
- 返金額は商品代金 + 送料（条件による）
- 返金処理完了メールを自動送信
- 返金処理は検品完了後3営業日以内（SLA）

#### AC-5: 交換商品の出荷
**Given** 交換申請が承認され、返品商品が確認済み  
**When** 交換商品の出荷指示が生成される  
**Then** 交換商品が出荷され、顧客に追跡番号が通知される

**詳細説明:**
- 返品商品確認後に交換商品を自動出荷
- 交換商品の配送料は無料（初回購入時の不備の場合）
- 出荷完了メールを自動送信
- 元の注文IDと紐付けて履歴管理

#### AC-6: 返品・交換履歴の管理
**Given** カスタマーサポートが管理画面にアクセス  
**When** 返品・交換一覧を確認  
**Then** ステータス別、期間別、理由別に返品・交換を検索・フィルタリングできる

**詳細説明:**
- 返品・交換のステータス（申請中、承認、却下、処理中、完了）
- 返品理由の集計レポート
- 返品率の推移グラフ
- 商品別・カテゴリー別の返品率
- CSV/PDFエクスポート機能

### 非機能要件

#### パフォーマンス
- [ ] 返品申請APIのP95レスポンスタイム: 200ms以内
- [ ] 返金処理のSLA: 検品完了後3営業日以内

#### セキュリティ
- [ ] 返品申請は本人確認必須（注文者のみ申請可能）
- [ ] 返金先口座情報は暗号化保存
- [ ] 不正返品の検知（同一ユーザーの頻繁な返品）

#### 可用性
- [ ] 返品・交換サービスのSLA: 99.5%

#### 保守性
- [ ] 返品・交換操作の監査ログ
- [ ] 不正返品疑いのアラート
- [ ] 返品率の異常検知

## UI/UX要件

### 画面遷移
```
[注文履歴] → [返品/交換申請] → [申請確認] → [返品ラベル発行] → [返品追跡] → [返金確認]
                    ↓
          [交換商品選択] → [交換確認] → [交換商品出荷]
```

### ワイヤーフレーム
- **返品申請画面**: 注文内容表示、返品理由選択、返品方法選択
- **交換申請画面**: 交換希望商品選択、在庫確認、差額表示
- **返品追跡画面**: 返品ステータス、検品結果、返金予定日
- **管理画面**: 返品・交換一覧、ステータスフィルター、検品入力

### インタラクション
- 返品申請時に返品ポリシーを明示（14日以内、未使用品のみ等）
- 交換商品の在庫確認結果を即座に表示
- 返品追跡ステータスをタイムライン形式で表示
- 返金完了時にプッシュ通知（オプション）

## 技術要件

### API仕様

#### エンドポイント: 返品申請
- **メソッド:** POST
- **パス:** `/api/v1/returns`
- **認証:** Required（JWT）

**リクエスト:**
```json
{
  "orderId": "ord_123456",
  "items": [
    {
      "orderLineId": "line_001",
      "quantity": 1,
      "reason": "size_mismatch",
      "comment": "サイズが大きすぎました"
    }
  ],
  "returnMethod": "pickup"
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "returnId": "ret_001",
    "status": "pending",
    "returnLabelUrl": "https://storage.example.com/return_label_001.pdf",
    "returnDeadline": "2025-11-25"
  }
}
```

#### エンドポイント: 交換申請
- **メソッド:** POST
- **パス:** `/api/v1/exchanges`
- **認証:** Required（JWT）

**リクエスト:**
```json
{
  "orderId": "ord_123456",
  "returnItems": [
    {
      "orderLineId": "line_001",
      "quantity": 1
    }
  ],
  "exchangeItems": [
    {
      "skuId": "sku_XYZ789",
      "quantity": 1
    }
  ]
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "exchangeId": "exch_001",
    "status": "pending",
    "priceDifference": 500,
    "additionalPaymentRequired": true
  }
}
```

#### エンドポイント: 返品検品登録
- **メソッド:** POST
- **パス:** `/api/v1/admin/returns/{returnId}/inspect`
- **認証:** Required（倉庫担当者権限）

**リクエスト:**
```json
{
  "inspectionResult": "approved",
  "itemCondition": "unused",
  "notes": "タグ付き未使用品"
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "returnId": "ret_001",
    "status": "inspected",
    "refundAmount": 2980,
    "refundScheduledDate": "2025-11-18"
  }
}
```

### データモデル

#### エンティティ: Return
```
Return:
- returnId: UUID (主キー)
- orderId: UUID (外部キー -> Order)
- userId: UUID (外部キー -> User)
- returnType: Enum (return, exchange)
- status: Enum (pending, approved, rejected, inspecting, inspected, refunded, completed)
- returnMethod: Enum (pickup, self_shipping)
- trackingNumber: String (null可)
- returnLabelUrl: String (null可)
- requestedAt: Timestamp
- deadlineAt: Timestamp
- inspectedAt: Timestamp (null可)
- refundedAt: Timestamp (null可)
- createdAt: Timestamp
- updatedAt: Timestamp
```

#### エンティティ: ReturnItem
```
ReturnItem:
- returnItemId: UUID (主キー)
- returnId: UUID (外部キー -> Return)
- orderLineId: UUID (外部キー -> OrderLine)
- skuId: UUID (外部キー -> SKU)
- quantity: Integer
- reason: Enum (size_mismatch, color_mismatch, defect, not_as_expected, other)
- comment: Text (null可)
- inspectionResult: Enum (approved, rejected) (null可)
- itemCondition: Enum (unused, used, damaged) (null可)
```

#### エンティティ: Exchange
```
Exchange:
- exchangeId: UUID (主キー)
- returnId: UUID (外部キー -> Return)
- newOrderId: UUID (外部キー -> Order、交換用新規注文)
- priceDifference: Decimal
- additionalPaymentRequired: Boolean
- status: Enum (pending, approved, shipped, completed)
- createdAt: Timestamp
```

#### エンティティ: Refund
```
Refund:
- refundId: UUID (主キー)
- returnId: UUID (外部キー -> Return)
- orderId: UUID (外部キー -> Order)
- refundAmount: Decimal
- refundMethod: Enum (credit_card, bank_transfer)
- refundStatus: Enum (pending, processing, completed, failed)
- refundedAt: Timestamp (null可)
- transactionId: String (決済プロバイダーのトランザクションID)
- createdAt: Timestamp
```

#### リレーションシップ
- Order 1:N Return
- Return 1:N ReturnItem
- Return 1:1 Exchange (null可)
- Return 1:1 Refund (null可)

### ビジネスルール参照
- BR-RET-001: 返品可能期間は商品到着後14日以内
- BR-RET-002: 未使用品のみ返品可能（タグ付き、未洗濯）
- BR-RET-003: セール品は返品不可（一部例外あり）
- BR-RET-004: 返金は検品完了後3営業日以内
- BR-RET-005: 不正返品の疑いがある場合は承認を保留

## 依存関係

### 前提条件
- [ ] 注文管理機能が実装済み（US-003）
- [ ] 出荷管理機能が実装済み（US-006）
- [ ] 決済プロバイダーの返金API利用可能
- [ ] 在庫管理機能が実装済み（US-004）

### 依存するストーリー
- US-003: カート管理と注文確定
- US-004: 在庫管理と在庫ロック機能
- US-006: 出荷管理と物流連携

### ブロッカー
- 決済プロバイダーの返金API仕様確認
- 返品ポリシーの法務レビュー

## テスト戦略

### 単体テスト
- [ ] 返品可能期間チェックロジック
- [ ] 返金額計算ロジック
- [ ] 交換商品の在庫確認ロジック
- [ ] カバレッジ目標: 85%以上

### 統合テスト
- [ ] 返品申請→検品→返金のフロー
- [ ] 交換申請→返品確認→交換商品出荷のフロー
- [ ] 在庫復元処理
- [ ] 決済プロバイダーAPI連携（サンドボックス）

### E2Eテスト
- [ ] 顧客が返品申請→倉庫検品→返金完了
- [ ] 顧客が交換申請→返品確認→交換商品受取
- [ ] 不正返品検知シナリオ

### 性能テスト
- [ ] 返品申請API: 500 req/sec で P95 < 200ms

## 実装計画

### タスク分解
1. [ ] データモデル設計とマイグレーション
   - 見積もり: 6時間
   - 担当: バックエンドエンジニア
2. [ ] 返品申請API実装
   - 見積もり: 10時間
   - 担当: バックエンドエンジニア
3. [ ] 交換申請API実装
   - 見積もり: 10時間
   - 担当: バックエンドエンジニア
4. [ ] 返品検品・承認機能実装
   - 見積もり: 8時間
   - 担当: バックエンドエンジニア
5. [ ] 返金処理API実装（決済プロバイダー連携）
   - 見積もり: 10時間
   - 担当: バックエンドエンジニア
6. [ ] 在庫復元ロジック実装
   - 見積もり: 6時間
   - 担当: バックエンドエンジニア
7. [ ] 顧客向けUI実装（返品・交換申請、追跡）
   - 見積もり: 12時間
   - 担当: フロントエンドエンジニア
8. [ ] 管理画面UI実装（検品、承認、返金処理）
   - 見積もり: 10時間
   - 担当: フロントエンドエンジニア
9. [ ] テスト実装（単体・統合・E2E）
   - 見積もり: 12時間
   - 担当: QAエンジニア

### 技術的考慮事項
- 返品ラベルはPDF生成（配送業者APIまたは自社生成）
- 返金処理は冪等性を保証（重複返金防止）
- 不正返品検知はルールベース（同一ユーザーの返品頻度、高額商品の返品等）
- 返品理由はテキストマイニングで分析可能に（将来）
- 在庫復元は在庫トランザクションとして記録

### リスクと対策
| リスク | 影響度 | 対策 |
|--------|--------|------|
| 不正返品の増加 | Medium | 返品履歴分析、検品強化、ポリシー厳格化 |
| 返金処理の遅延 | Medium | 自動化推進、SLA設定、アラート |
| 返品商品の在庫復元ミス | Medium | 厳格な検品、バーコードスキャン |
| 決済プロバイダーAPI障害 | Medium | リトライ機構、手動返金フォールバック |

## 完了の定義（Definition of Done）

- [ ] コードが実装され、レビューが完了している
- [ ] 全ての受入基準が満たされている
- [ ] 単体テストが実装され、全てパスしている（カバレッジ85%以上）
- [ ] 統合テストが実装され、全てパスしている
- [ ] E2Eテストが実装され、全てパスしている
- [ ] セキュリティレビューが完了している
- [ ] API仕様書が更新されている
- [ ] ステージング環境でのテストが完了している
- [ ] プロダクトオーナーによる受入テストが完了している
- [ ] 返品ポリシーのドキュメント化完了

## 参考資料

### 関連ドキュメント
- [プロジェクト概要](../project-overview.md)
- [返品テーブル定義](../data/schema/return.sql)

### 外部参照
- [消費者契約法](https://elaws.e-gov.go.jp/document?lawid=412AC0000000061)
- [特定商取引法](https://www.no-trouble.caa.go.jp/)

## 備考・コメント

### 設計上の決定事項
- 返品期限は商品到着後14日間（業界標準）
- 交換は在庫がある場合のみ自動承認
- 返金はクレジットカード返金を優先

### 技術的負債
- AI画像認識による自動検品は将来対応
- 返品理由のテキストマイニング分析は将来対応

### 将来の拡張性
- 試着サービス（複数サイズを送付、1つ選択して残りは返品）
- リアルタイム返品承認（AIによる自動承認）
- 店舗での返品受付（オムニチャネル）

---

## 変更履歴

| 日付 | 変更者 | 変更内容 |
|------|--------|----------|
| 2025-11-11 | AI Assistant | 初版作成 |
