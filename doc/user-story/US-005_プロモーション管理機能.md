# ユーザーストーリー：プロモーション管理機能

## 基本情報

| 項目 | 内容 |
|------|------|
| **ID** | US-005 |
| **タイトル** | プロモーション・クーポン管理機能の実装 |
| **ステータス** | Draft |
| **優先度** | High |
| **見積もり** | 13ストーリーポイント |
| **担当者** | 未割当 |
| **作成日** | 2025-11-11 |
| **更新日** | 2025-11-11 |

## ユーザーストーリー

**As a** マーケティング担当者  
**I want** セール、クーポン、タイムセールなどのプロモーションを柔軟に設定・管理できる  
**So that** 顧客の購買意欲を高め、売上を最大化できる

### 日本語記述

マーケティング担当者として、売上を最大化するために、セール、クーポン、タイムセールなどの多様なプロモーションを柔軟に設定・管理できる機能が必要である。

## 背景・目的

### ビジネス背景
ファッションECでは、季節の変わり目、イベント（ブラックフライデー、年末年始等）、在庫処分などのタイミングで頻繁にプロモーションを実施する。プロジェクト概要では「マーケティング施策（セール、タイムセール、予約販売等）を短いサイクルで実行」することが明記されており、プロモーション管理機能は事業の根幹を支える重要な機能である。

### ユーザーニーズ
- **マーケティング担当者**: 複雑な割引ルールを簡単に設定したい、効果測定したい
- **顧客**: お得なセールやクーポンで購入したい、限定セールに参加したい
- **運営**: プロモーションの自動開始・終了で運用負荷を削減したい

### 現状の課題
- プロモーションルールが複雑化し、手動管理では運用が困難
- 複数のプロモーションが重複した場合の優先順位管理
- タイムセールなど時間制約のあるプロモーションの自動制御
- 在庫連動型プロモーション（在庫が一定数以下で終了）の実現

## 受入基準（Acceptance Criteria）

### 機能要件

#### AC-1: プロモーション作成
**Given** マーケティング担当者が管理画面にログインしている  
**When** プロモーション設定画面で条件と割引内容を入力する  
**Then** プロモーションが作成され、指定した期間内で自動的に適用される

**詳細説明:**
- プロモーションタイプ: パーセント割引、固定額割引、BOGO（Buy One Get One）、送料無料
- 適用条件: 対象商品、対象カテゴリー、最低購入金額、購入数量
- 期間設定: 開始日時・終了日時（タイムゾーン対応）
- 利用制限: 1ユーザーあたりの利用回数、総利用回数
- 優先順位: 複数プロモーション適用時の優先度設定

#### AC-2: クーポンコード発行
**Given** マーケティング担当者がクーポンを作成する  
**When** クーポンコードを発行する  
**Then** ユーザーがそのコードを入力することで割引が適用される

**詳細説明:**
- クーポンコードは一意（重複チェック）
- 自動生成または手動入力
- 有効期限設定
- 利用制限（1回限り、複数回利用可）
- ユーザー限定クーポン（特定ユーザーのみ利用可能）

#### AC-3: タイムセール機能
**Given** マーケティング担当者がタイムセールを設定する  
**When** 設定した開始時刻になる  
**Then** 対象商品の価格が自動的に割引され、終了時刻に元の価格に戻る

**詳細説明:**
- 秒単位での開始・終了時刻設定
- カウントダウンタイマーの表示（フロントエンド）
- 在庫連動（在庫切れで自動終了）
- 先着〇〇名限定の設定
- タイムセール開始前の予告表示

#### AC-4: プロモーション適用計算
**Given** ユーザーがカートに商品を追加している  
**When** 適用可能なプロモーションがある  
**Then** 最もお得なプロモーションが自動的に適用される

**詳細説明:**
- 複数プロモーション適用時の優先順位制御
- 割引額を自動計算して表示
- クーポンコード入力による手動適用
- プロモーション適用後の最終価格をプレビュー表示
- 適用されたプロモーション名を明示

#### AC-5: 予約販売対応
**Given** 未発売商品に対して予約販売プロモーションを設定  
**When** ユーザーが予約購入を確定する  
**Then** 在庫が先行して引き当てられ、発売日に自動出荷される

**詳細説明:**
- 予約販売の開始・終了日時設定
- 予約可能数量の制限
- 予約時の決済タイミング（即時 or 発売日）
- 発売日の自動出荷トリガー
- 予約状況のリアルタイム表示

#### AC-6: プロモーション効果測定
**Given** プロモーションが終了した  
**When** マーケティング担当者が効果レポートを確認する  
**Then** 利用回数、売上、割引総額などの統計が表示される

**詳細説明:**
- 利用回数、ユニークユーザー数
- 割引総額、売上への貢献度
- 対象商品別の売上
- 時系列での利用推移
- CSV/PDFエクスポート機能

### 非機能要件

#### パフォーマンス
- [ ] プロモーション適用計算のP95レスポンスタイム: 100ms以内
- [ ] タイムセール開始時の同時アクセス: 秒間5000リクエストに耐える
- [ ] クーポン検証APIのP99レスポンスタイム: 50ms以内

#### セキュリティ
- [ ] クーポンコードのブルートフォース攻撃対策
- [ ] プロモーション設定は管理者権限必須
- [ ] 価格改ざん防止（サーバー側で割引額を再計算）

#### 可用性
- [ ] プロモーションサービスのSLA: 99.9%
- [ ] タイムセール開始時の高負荷対策

#### 保守性
- [ ] プロモーション適用履歴の記録
- [ ] 不正利用の検知とアラート
- [ ] プロモーション設定変更の監査ログ

## UI/UX要件

### 画面遷移
```
[プロモーション一覧] → [プロモーション作成/編集] → [プレビュー] → [公開]
         ↓
[効果レポート]
```

### ワイヤーフレーム
- **プロモーション一覧**: 進行中、予定、終了のタブ、ステータス表示
- **プロモーション作成画面**: タイプ選択、条件設定、割引設定、期間設定
- **クーポン管理画面**: クーポンコード一覧、発行、無効化
- **顧客向けUI**: 割引バッジ、カウントダウンタイマー、クーポン入力欄

### インタラクション
- プロモーション作成時にプレビュー機能（どのように表示されるか確認）
- タイムセールのカウントダウンタイマー（リアルタイム更新）
- クーポン入力時の即座なバリデーションとエラー表示
- 割引適用後の価格変化をアニメーションで表示

## 技術要件

### API仕様

#### エンドポイント: プロモーション作成
- **メソッド:** POST
- **パス:** `/api/v1/admin/promotions`
- **認証:** Required（管理者権限）

**リクエスト:**
```json
{
  "name": "ウィンターセール2025",
  "promotionType": "percentage_discount",
  "discountValue": 20,
  "conditions": {
    "minPurchaseAmount": 5000,
    "targetProducts": ["prod_001", "prod_002"],
    "targetCategories": ["cat_winter"]
  },
  "startDate": "2025-12-01T00:00:00Z",
  "endDate": "2025-12-31T23:59:59Z",
  "usageLimit": {
    "totalUsageLimit": 1000,
    "perUserLimit": 1
  },
  "priority": 10
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "promotionId": "promo_123",
    "name": "ウィンターセール2025",
    "status": "scheduled"
  }
}
```

#### エンドポイント: クーポン適用
- **メソッド:** POST
- **パス:** `/api/v1/cart/apply-coupon`
- **認証:** Required（JWT）

**リクエスト:**
```json
{
  "cartId": "cart_456",
  "couponCode": "WINTER2025"
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "appliedCoupon": {
      "couponCode": "WINTER2025",
      "discountAmount": 1000
    },
    "cart": {
      "subtotal": 5000,
      "discountAmount": 1000,
      "total": 4000
    }
  }
}
```

**レスポンス（エラー）:**
```json
{
  "status": "error",
  "error": {
    "code": "INVALID_COUPON",
    "message": "このクーポンは利用できません"
  }
}
```

#### エンドポイント: 適用可能プロモーション取得
- **メソッド:** GET
- **パス:** `/api/v1/promotions/applicable`
- **認証:** Optional

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "promotions": [
      {
        "promotionId": "promo_123",
        "name": "ウィンターセール2025",
        "promotionType": "percentage_discount",
        "discountValue": 20,
        "endsAt": "2025-12-31T23:59:59Z"
      }
    ]
  }
}
```

### データモデル

#### エンティティ: Promotion
```
Promotion:
- promotionId: UUID (主キー)
- name: String
- description: Text
- promotionType: Enum (percentage_discount, fixed_amount, bogo, free_shipping)
- discountValue: Decimal
- startDate: Timestamp
- endDate: Timestamp
- status: Enum (draft, scheduled, active, ended, cancelled)
- priority: Integer (優先順位、高い値が優先)
- totalUsageLimit: Integer (null可)
- perUserLimit: Integer (null可)
- currentUsageCount: Integer (デフォルト: 0)
- createdBy: UUID (外部キー -> User)
- createdAt: Timestamp
- updatedAt: Timestamp
```

#### エンティティ: PromotionCondition
```
PromotionCondition:
- conditionId: UUID (主キー)
- promotionId: UUID (外部キー -> Promotion)
- conditionType: Enum (min_purchase_amount, product_list, category_list, user_segment)
- conditionValue: JSONB (柔軟な条件定義)
```

#### エンティティ: Coupon
```
Coupon:
- couponId: UUID (主キー)
- promotionId: UUID (外部キー -> Promotion)
- couponCode: String (一意、インデックス)
- isActive: Boolean
- expiresAt: Timestamp
- usageLimit: Integer (null = 無制限)
- currentUsageCount: Integer (デフォルト: 0)
- restrictedToUserId: UUID (null可、特定ユーザー限定)
- createdAt: Timestamp
```

#### エンティティ: PromotionUsage
```
PromotionUsage:
- usageId: UUID (主キー)
- promotionId: UUID (外部キー -> Promotion)
- couponId: UUID (外部キー -> Coupon、null可)
- orderId: UUID (外部キー -> Order)
- userId: UUID (外部キー -> User)
- discountAmount: Decimal
- usedAt: Timestamp
```

#### リレーションシップ
- Promotion 1:N PromotionCondition
- Promotion 1:N Coupon
- Promotion 1:N PromotionUsage
- Order 1:N PromotionUsage

### ビジネスルール参照
- BR-PROMO-001: 複数プロモーション適用時は優先順位の高いものを優先
- BR-PROMO-002: クーポンと自動プロモーションは併用可能（設定による）
- BR-PROMO-003: プロモーション適用後の価格は0円未満にならない
- BR-PROMO-004: タイムセール中の在庫切れは即座に終了ステータスに変更

## 依存関係

### 前提条件
- [ ] 商品・カテゴリーマスタが構築されている
- [ ] 注文管理機能が実装済み（US-003）
- [ ] スケジューラー（cron job or 非同期タスク）が利用可能

### 依存するストーリー
- US-003: カート管理と注文確定
- US-004: 在庫管理と在庫ロック機能

### ブロッカー
- プロモーションルールの複雑性に対する仕様決定
- タイムセール開始時の高負荷対策の技術選定

## テスト戦略

### 単体テスト
- [ ] プロモーション適用ロジック（各タイプの割引計算）
- [ ] 優先順位による適用順序
- [ ] クーポンバリデーション（有効期限、利用回数）
- [ ] カバレッジ目標: 90%以上

### 統合テスト
- [ ] プロモーション作成→適用→注文確定のフロー
- [ ] 複数プロモーション併用シナリオ
- [ ] タイムセール開始・終了の自動制御
- [ ] 在庫連動プロモーションの動作

### E2Eテスト
- [ ] ユーザーがクーポンコードを入力して割引を受ける
- [ ] タイムセール開始と同時に価格が変更される
- [ ] 予約販売で注文→発売日に自動出荷

### 性能テスト
- [ ] タイムセール開始時: 5000 req/sec で正常動作
- [ ] プロモーション適用計算: P95 < 100ms
- [ ] クーポン検証: P99 < 50ms

## 実装計画

### タスク分解
1. [ ] データモデル設計とマイグレーション
   - 見積もり: 6時間
   - 担当: バックエンドエンジニア
2. [ ] プロモーション作成・編集API実装
   - 見積もり: 10時間
   - 担当: バックエンドエンジニア
3. [ ] クーポン発行・管理API実装
   - 見積もり: 8時間
   - 担当: バックエンドエンジニア
4. [ ] プロモーション適用エンジン実装
   - 見積もり: 12時間
   - 担当: バックエンドエンジニア
5. [ ] タイムセール自動開始・終了機構
   - 見積もり: 8時間
   - 担当: バックエンドエンジニア
6. [ ] 効果測定レポート機能
   - 見積もり: 8時間
   - 担当: バックエンドエンジニア
7. [ ] 管理画面UI実装
   - 見積もり: 16時間
   - 担当: フロントエンドエンジニア
8. [ ] 顧客向けUI実装（カウントダウン、クーポン入力）
   - 見積もり: 10時間
   - 担当: フロントエンドエンジニア
9. [ ] テスト実装（単体・統合・E2E・性能）
   - 見積もり: 14時間
   - 担当: QAエンジニア

### 技術的考慮事項
- プロモーション適用ロジックはルールエンジンパターンで実装
- タイムセール開始はスケジューラーで定期チェック（1分間隔）
- 高負荷対策としてプロモーション情報をRedisにキャッシュ
- クーポンコード検証はBloom Filterで高速化検討
- 価格計算は必ずサーバー側で実施（改ざん防止）

### リスクと対策
| リスク | 影響度 | 対策 |
|--------|--------|------|
| タイムセール開始時の高負荷 | High | CDN活用、Redisキャッシュ、水平スケール |
| クーポン不正利用 | Medium | レート制限、ユーザーごとの利用履歴チェック |
| プロモーションルール複雑化 | Medium | ルールエンジンで拡張可能な設計 |
| 割引計算のバグ | High | 徹底したテスト、手動レビュー |

## 完了の定義（Definition of Done）

- [ ] コードが実装され、レビューが完了している
- [ ] 全ての受入基準が満たされている
- [ ] 単体テストが実装され、全てパスしている（カバレッジ90%以上）
- [ ] 統合テストが実装され、全てパスしている
- [ ] E2Eテストが実装され、全てパスしている
- [ ] 性能テストが完了し、タイムセール開始時の負荷テストをクリア
- [ ] セキュリティレビューが完了している
- [ ] API仕様書が更新されている
- [ ] ステージング環境でのテストが完了している
- [ ] プロダクトオーナーによる受入テストが完了している
- [ ] 監視・アラート設定が完了している

## 参考資料

### 関連ドキュメント
- [プロジェクト概要](../project-overview.md)
- [プロモーションテーブル定義](../data/schema/promotion.sql)

### 外部参照
- [ルールエンジンパターン](https://martinfowler.com/bliki/RulesEngine.html)
- [Bloom Filter](https://en.wikipedia.org/wiki/Bloom_filter)

## 備考・コメント

### 設計上の決定事項
- プロモーションルールはJSONBで柔軟に定義（将来の拡張性）
- 優先順位ベースで複数プロモーション制御
- クーポンとプロモーションは別テーブルで管理

### 技術的負債
- AIによる最適プロモーション推薦は将来対応
- A/Bテスト機能は将来対応
- ポイント制度は将来対応

### 将来の拡張性
- ユーザーセグメント別プロモーション（VIP向け等）
- 友達紹介プロモーション
- ロイヤリティプログラム統合
- パーソナライズドプロモーション（AIレコメンド）

---

## 変更履歴

| 日付 | 変更者 | 変更内容 |
|------|--------|----------|
| 2025-11-11 | AI Assistant | 初版作成 |
