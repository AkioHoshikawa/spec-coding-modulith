# US-005：プロモーション管理機能

## 基本情報

| 項目 | 内容 |
|------|------|
| **ID** | US-005 |
| **タイトル** | プロモーション・クーポン管理機能の実装 |

## ユーザーストーリー

**As a** マーケティング担当者  
**I want** セール、クーポン、タイムセールなどのプロモーションを柔軟に設定・管理できる  
**So that** 顧客の購買意欲を高め、売上を最大化できる

### 日本語記述

マーケティング担当者として、売上を最大化するために、セール、クーポン、タイムセールなどの多様なプロモーションを柔軟に設定・管理できる機能が必要である。

## 背景・目的

### ビジネス背景
ファッションECでは、季節の変わり目、イベント（ブラックフライデー、年末年始等）、在庫処分などのタイミングで頻繁にプロモーションを実施する。プロジェクト概要では「マーケティング施策（セール、タイムセール、予約販売等）を短いサイクルで実行」することが明記されており、プロモーション管理機能は事業の根幹を支える重要な機能である。

### ユーザーニーズ
- **マーケティング担当者**: 複雑な割引ルールを簡単に設定したい、効果測定したい
- **顧客**: お得なセールやクーポンで購入したい、限定セールに参加したい
- **運営**: プロモーションの自動開始・終了で運用負荷を削減したい

### 現状の課題
- プロモーションルールが複雑化し、手動管理では運用が困難
- 複数のプロモーションが重複した場合の優先順位管理
- タイムセールなど時間制約のあるプロモーションの自動制御
- 在庫連動型プロモーション（在庫が一定数以下で終了）の実現

## 受入基準（Acceptance Criteria）

### 機能要件

#### AC-1: プロモーション作成
**Given** マーケティング担当者が管理画面にログインしている  
**When** プロモーション設定画面で条件と割引内容を入力する  
**Then** プロモーションが作成され、指定した期間内で自動的に適用される

**詳細説明:**
- プロモーションタイプ: パーセント割引、固定額割引、BOGO（Buy One Get One）、送料無料
- 適用条件: 対象商品、対象カテゴリー、最低購入金額、購入数量
- 期間設定: 開始日時・終了日時（タイムゾーン対応）
- 利用制限: 1ユーザーあたりの利用回数、総利用回数
- 優先順位: 複数プロモーション適用時の優先度設定

#### AC-2: クーポンコード発行
**Given** マーケティング担当者がクーポンを作成する  
**When** クーポンコードを発行する  
**Then** ユーザーがそのコードを入力することで割引が適用される

**詳細説明:**
- クーポンコードは一意（重複チェック）
- 自動生成または手動入力
- 有効期限設定
- 利用制限（1回限り、複数回利用可）
- ユーザー限定クーポン（特定ユーザーのみ利用可能）

#### AC-3: タイムセール機能
**Given** マーケティング担当者がタイムセールを設定する  
**When** 設定した開始時刻になる  
**Then** 対象商品の価格が自動的に割引され、終了時刻に元の価格に戻る

**詳細説明:**
- 秒単位での開始・終了時刻設定
- カウントダウンタイマーの表示（フロントエンド）
- 在庫連動（在庫切れで自動終了）
- 先着〇〇名限定の設定
- タイムセール開始前の予告表示

#### AC-4: プロモーション適用計算
**Given** ユーザーがカートに商品を追加している  
**When** 適用可能なプロモーションがある  
**Then** 最もお得なプロモーションが自動的に適用される

**詳細説明:**
- 複数プロモーション適用時の優先順位制御
- 割引額を自動計算して表示
- クーポンコード入力による手動適用
- プロモーション適用後の最終価格をプレビュー表示
- 適用されたプロモーション名を明示

#### AC-5: 予約販売対応
**Given** 未発売商品に対して予約販売プロモーションを設定  
**When** ユーザーが予約購入を確定する  
**Then** 在庫が先行して引き当てられ、発売日に自動出荷される

**詳細説明:**
- 予約販売の開始・終了日時設定
- 予約可能数量の制限
- 予約時の決済タイミング（即時 or 発売日）
- 発売日の自動出荷トリガー
- 予約状況のリアルタイム表示

#### AC-6: プロモーション効果測定
**Given** プロモーションが終了した  
**When** マーケティング担当者が効果レポートを確認する  
**Then** 利用回数、売上、割引総額などの統計が表示される

**詳細説明:**
- 利用回数、ユニークユーザー数
- 割引総額、売上への貢献度
- 対象商品別の売上
- 時系列での利用推移
- CSV/PDFエクスポート機能

### 非機能要件

#### パフォーマンス
- [ ] プロモーション適用計算のP95レスポンスタイム: 100ms以内
- [ ] タイムセール開始時の同時アクセス: 秒間5000リクエストに耐える
- [ ] クーポン検証APIのP99レスポンスタイム: 50ms以内

#### セキュリティ
- [ ] クーポンコードのブルートフォース攻撃対策
- [ ] プロモーション設定は管理者権限必須
- [ ] 価格改ざん防止（サーバー側で割引額を再計算）

#### 可用性
- [ ] プロモーションサービスのSLA: 99.9%
- [ ] タイムセール開始時の高負荷対策

#### 保守性
- [ ] プロモーション適用履歴の記録
- [ ] 不正利用の検知とアラート
- [ ] プロモーション設定変更の監査ログ

## UI/UX要件

### 画面遷移
```
[プロモーション一覧] → [プロモーション作成/編集] → [プレビュー] → [公開]
         ↓
[効果レポート]
```

### インタラクション
- プロモーション作成時にプレビュー機能（どのように表示されるか確認）
- タイムセールのカウントダウンタイマー（リアルタイム更新）
- クーポン入力時の即座なバリデーションとエラー表示
- 割引適用後の価格変化をアニメーションで表示

## 依存関係

### 前提条件
- [ ] 商品・カテゴリーマスタが構築されている
- [ ] 注文管理機能が実装済み（US-003）
- [ ] スケジューラー（cron job or 非同期タスク）が利用可能

### 依存するストーリー
- US-003: カート管理と注文確定
- US-004: 在庫管理と在庫ロック機能

### ブロッカー
- プロモーションルールの複雑性に対する仕様決定
- タイムセール開始時の高負荷対策の技術選定

## 備考・コメント

### 設計上の決定事項
- プロモーションルールはJSONBで柔軟に定義（将来の拡張性）
- 優先順位ベースで複数プロモーション制御
- クーポンとプロモーションは別テーブルで管理

### 将来の拡張性
- ユーザーセグメント別プロモーション（VIP向け等）
- 友達紹介プロモーション
- ロイヤリティプログラム統合
- パーソナライズドプロモーション（AIレコメンド）

