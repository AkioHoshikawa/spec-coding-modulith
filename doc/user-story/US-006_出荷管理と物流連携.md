# US-006：出荷管理と物流連携

## 基本情報

| 項目 | 内容 |
|------|------|
| **ID** | US-006 |
| **タイトル** | 出荷管理と3PL連携機能の実装 |

## ユーザーストーリー

**As a** 倉庫担当者  
**I want** 注文確定後に出荷指示を自動生成し、3PLと連携して配送を管理できる  
**So that** 効率的に商品を出荷し、顧客に正確な配送情報を提供できる

### 日本語記述

倉庫担当者として、効率的な出荷業務と正確な配送追跡を実現するために、出荷指示の自動生成と3PL/配送業者とのAPI連携機能が必要である。

## 背景・目的

### ビジネス背景
ファッションECでは、注文確定から出荷までのリードタイムを短縮し、顧客に迅速に商品を届けることが競争力となる。プロジェクト概要では「3PL/配送業者とのAPI連携（出荷指示、配送追跡）」が明記されており、外部物流パートナーとシームレスに連携することが求められている。

### ユーザーニーズ
- **倉庫担当者**: ピッキングリストを効率的に生成し、作業を最適化したい
- **顧客**: 注文後の配送状況をリアルタイムで確認したい
- **カスタマーサポート**: 配送遅延時に迅速に顧客対応したい
- **運営**: 出荷処理を自動化し、人的ミスを削減したい

### 現状の課題
- 手動での出荷指示は時間がかかり、ミスが発生しやすい
- 複数の3PL/配送業者との連携が個別対応で運用負荷が高い
- 配送状況の追跡が手動で、リアルタイム性に欠ける
- 出荷遅延の検知と対応が遅れる

## 受入基準（Acceptance Criteria）

### 機能要件

#### AC-1: 出荷指示の自動生成
**Given** 注文が確定し決済が完了している  
**When** 出荷準備ステータスに移行する  
**Then** 倉庫拠点ごとにピッキングリストと出荷指示が自動生成される

**詳細説明:**
- 在庫引当情報に基づき、倉庫拠点ごとに出荷指示を分割
- ピッキングリストにはSKU、商品名、数量、保管場所が記載
- 配送先住所、配送希望日時が含まれる
- 出荷指示番号（一意）が発行される
- PDF形式でダウンロード可能

#### AC-2: 3PL API連携による配送伝票発行
**Given** 出荷指示が生成されている  
**When** 「配送伝票発行」ボタンを押下する  
**Then** 3PL/配送業者のAPIを呼び出し、配送伝票番号が取得される

**詳細説明:**
- 3PL APIに配送先情報、荷物情報を送信
- 配送伝票番号（追跡番号）を取得し、Shipmentテーブルに保存
- 配送業者のラベル（PDF）をダウンロード可能
- API呼び出し失敗時はリトライ機構（3回まで）
- 複数の3PL業者に対応（アダプタパターンで実装）

#### AC-3: 出荷完了登録
**Given** 倉庫担当者が商品をピッキングし梱包完了  
**When** 「出荷完了」ボタンを押下する  
**Then** 注文ステータスが「出荷済み」に更新され、顧客に出荷完了メールが送信される

**詳細説明:**
- 出荷日時を記録
- 在庫ステータスを「引当済」から「出荷済」に更新
- 顧客に出荷完了メール（追跡番号付き）を送信
- 出荷履歴を記録（監査ログ）

#### AC-4: 配送追跡情報の取得
**Given** 出荷が完了している  
**When** 配送業者のAPIから配送ステータスを取得する  
**Then** 配送状況（集荷、輸送中、配達中、配達完了）がリアルタイムで更新される

**詳細説明:**
- 定期的に配送業者APIをポーリング（1時間ごと）
- Webhook対応可能な業者はWebhookで即座に更新
- 配送ステータス変更時、顧客にプッシュ通知（オプション）
- 配送遅延検知（予定配達日を過ぎても未配達）のアラート

#### AC-5: 顧客向け配送追跡画面
**Given** 顧客がマイページにアクセス  
**When** 注文詳細から「配送状況を確認」を選択  
**Then** 配送業者の追跡情報がタイムライン形式で表示される

**詳細説明:**
- 配送ステータスの履歴表示（集荷日時、輸送中、配達完了日時）
- 配送業者の公式追跡ページへのリンク
- 配達予定日の表示
- 再配達依頼のリンク（配送業者サイトへ）

#### AC-6: 出荷遅延の検知とアラート
**Given** 出荷予定日を過ぎても出荷されていない  
**When** システムが定期チェックを実施  
**Then** 運営担当者にアラートメールが送信される

**詳細説明:**
- 注文確定から24時間以内に出荷されない場合、アラート
- 配送予定日を過ぎても配達されない場合、アラート
- アラート対象の注文一覧を管理画面で確認可能
- 手動でステータス更新・顧客連絡が可能

### 非機能要件

#### パフォーマンス
- [ ] 出荷指示生成のP95レスポンスタイム: 500ms以内
- [ ] 配送伝票発行APIのP99レスポンスタイム: 3秒以内（外部API依存）
- [ ] 配送追跡情報取得のP95レスポンスタイム: 200ms以内（キャッシュ活用）

#### セキュリティ
- [ ] 3PL API認証情報は環境変数またはKMSで安全に管理
- [ ] 出荷操作は認証・認可必須
- [ ] 配送先個人情報の暗号化保存

#### 可用性
- [ ] 3PL API障害時のグレースフルデグレード（手動出荷対応）
- [ ] リトライ機構による一時的障害への対応

#### 保守性
- [ ] 出荷操作の監査ログ記録
- [ ] 3PL API呼び出し履歴の記録（デバッグ用）
- [ ] 配送遅延アラートの自動化

## UI/UX要件

### 画面遷移
```
[注文一覧] → [出荷指示生成] → [ピッキングリスト] → [配送伝票発行] → [出荷完了]
     ↓
[配送追跡]
```

### インタラクション
- ピッキング完了時にチェックボックスで確認
- 出荷完了時に確認ダイアログ表示
- 配送伝票発行中はローディングスピナー表示
- 配送遅延時は注文を赤色でハイライト

## 依存関係

### 前提条件
- [ ] 注文管理機能が実装済み（US-003）
- [ ] 在庫管理機能が実装済み（US-004）
- [ ] 3PL/配送業者APIのサンドボックス環境が利用可能
- [ ] ストレージサービス（S3等）がPDF保存に利用可能

### 依存するストーリー
- US-003: カート管理と注文確定
- US-004: 在庫管理と在庫ロック機能

### ブロッカー
- 3PL/配送業者との契約とAPI仕様書の入手
- 配送業者ごとのAPIの差異を吸収するアダプタ実装

## 備考・コメント

### 設計上の決定事項
- 複数3PL業者対応のためアダプタパターン採用
- Webhook + ポーリングのハイブリッド方式で追跡情報更新
- 出荷遅延は自動検知しアラート

### 将来の拡張性
- リアルタイム配送地図表示
- 配送品質スコアリング（配送業者の評価）
- 自動配送業者選定（コスト・速度最適化）
- ラストワンマイル配送の自社化

