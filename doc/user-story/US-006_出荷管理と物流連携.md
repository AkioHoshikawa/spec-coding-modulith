# ユーザーストーリー：出荷管理と物流連携

## 基本情報

| 項目 | 内容 |
|------|------|
| **ID** | US-006 |
| **タイトル** | 出荷管理と3PL連携機能の実装 |
| **ステータス** | Draft |
| **優先度** | High |
| **見積もり** | 13ストーリーポイント |
| **担当者** | 未割当 |
| **作成日** | 2025-11-11 |
| **更新日** | 2025-11-11 |

## ユーザーストーリー

**As a** 倉庫担当者  
**I want** 注文確定後に出荷指示を自動生成し、3PLと連携して配送を管理できる  
**So that** 効率的に商品を出荷し、顧客に正確な配送情報を提供できる

### 日本語記述

倉庫担当者として、効率的な出荷業務と正確な配送追跡を実現するために、出荷指示の自動生成と3PL/配送業者とのAPI連携機能が必要である。

## 背景・目的

### ビジネス背景
ファッションECでは、注文確定から出荷までのリードタイムを短縮し、顧客に迅速に商品を届けることが競争力となる。プロジェクト概要では「3PL/配送業者とのAPI連携（出荷指示、配送追跡）」が明記されており、外部物流パートナーとシームレスに連携することが求められている。

### ユーザーニーズ
- **倉庫担当者**: ピッキングリストを効率的に生成し、作業を最適化したい
- **顧客**: 注文後の配送状況をリアルタイムで確認したい
- **カスタマーサポート**: 配送遅延時に迅速に顧客対応したい
- **運営**: 出荷処理を自動化し、人的ミスを削減したい

### 現状の課題
- 手動での出荷指示は時間がかかり、ミスが発生しやすい
- 複数の3PL/配送業者との連携が個別対応で運用負荷が高い
- 配送状況の追跡が手動で、リアルタイム性に欠ける
- 出荷遅延の検知と対応が遅れる

## 受入基準（Acceptance Criteria）

### 機能要件

#### AC-1: 出荷指示の自動生成
**Given** 注文が確定し決済が完了している  
**When** 出荷準備ステータスに移行する  
**Then** 倉庫拠点ごとにピッキングリストと出荷指示が自動生成される

**詳細説明:**
- 在庫引当情報に基づき、倉庫拠点ごとに出荷指示を分割
- ピッキングリストにはSKU、商品名、数量、保管場所が記載
- 配送先住所、配送希望日時が含まれる
- 出荷指示番号（一意）が発行される
- PDF形式でダウンロード可能

#### AC-2: 3PL API連携による配送伝票発行
**Given** 出荷指示が生成されている  
**When** 「配送伝票発行」ボタンを押下する  
**Then** 3PL/配送業者のAPIを呼び出し、配送伝票番号が取得される

**詳細説明:**
- 3PL APIに配送先情報、荷物情報を送信
- 配送伝票番号（追跡番号）を取得し、Shipmentテーブルに保存
- 配送業者のラベル（PDF）をダウンロード可能
- API呼び出し失敗時はリトライ機構（3回まで）
- 複数の3PL業者に対応（アダプタパターンで実装）

#### AC-3: 出荷完了登録
**Given** 倉庫担当者が商品をピッキングし梱包完了  
**When** 「出荷完了」ボタンを押下する  
**Then** 注文ステータスが「出荷済み」に更新され、顧客に出荷完了メールが送信される

**詳細説明:**
- 出荷日時を記録
- 在庫ステータスを「引当済」から「出荷済」に更新
- 顧客に出荷完了メール（追跡番号付き）を送信
- 出荷履歴を記録（監査ログ）

#### AC-4: 配送追跡情報の取得
**Given** 出荷が完了している  
**When** 配送業者のAPIから配送ステータスを取得する  
**Then** 配送状況（集荷、輸送中、配達中、配達完了）がリアルタイムで更新される

**詳細説明:**
- 定期的に配送業者APIをポーリング（1時間ごと）
- Webhook対応可能な業者はWebhookで即座に更新
- 配送ステータス変更時、顧客にプッシュ通知（オプション）
- 配送遅延検知（予定配達日を過ぎても未配達）のアラート

#### AC-5: 顧客向け配送追跡画面
**Given** 顧客がマイページにアクセス  
**When** 注文詳細から「配送状況を確認」を選択  
**Then** 配送業者の追跡情報がタイムライン形式で表示される

**詳細説明:**
- 配送ステータスの履歴表示（集荷日時、輸送中、配達完了日時）
- 配送業者の公式追跡ページへのリンク
- 配達予定日の表示
- 再配達依頼のリンク（配送業者サイトへ）

#### AC-6: 出荷遅延の検知とアラート
**Given** 出荷予定日を過ぎても出荷されていない  
**When** システムが定期チェックを実施  
**Then** 運営担当者にアラートメールが送信される

**詳細説明:**
- 注文確定から24時間以内に出荷されない場合、アラート
- 配送予定日を過ぎても配達されない場合、アラート
- アラート対象の注文一覧を管理画面で確認可能
- 手動でステータス更新・顧客連絡が可能

### 非機能要件

#### パフォーマンス
- [ ] 出荷指示生成のP95レスポンスタイム: 500ms以内
- [ ] 配送伝票発行APIのP99レスポンスタイム: 3秒以内（外部API依存）
- [ ] 配送追跡情報取得のP95レスポンスタイム: 200ms以内（キャッシュ活用）

#### セキュリティ
- [ ] 3PL API認証情報は環境変数またはKMSで安全に管理
- [ ] 出荷操作は認証・認可必須
- [ ] 配送先個人情報の暗号化保存

#### 可用性
- [ ] 3PL API障害時のグレースフルデグレード（手動出荷対応）
- [ ] リトライ機構による一時的障害への対応

#### 保守性
- [ ] 出荷操作の監査ログ記録
- [ ] 3PL API呼び出し履歴の記録（デバッグ用）
- [ ] 配送遅延アラートの自動化

## UI/UX要件

### 画面遷移
```
[注文一覧] → [出荷指示生成] → [ピッキングリスト] → [配送伝票発行] → [出荷完了]
     ↓
[配送追跡]
```

### ワイヤーフレーム
- **出荷指示一覧**: 未出荷注文一覧、拠点別フィルター
- **ピッキングリスト**: SKU、商品名、数量、保管場所、チェックボックス
- **配送伝票発行画面**: 配送業者選択、伝票番号表示、ラベル印刷
- **配送追跡画面**: タイムライン形式の配送ステータス、地図表示（オプション）

### インタラクション
- ピッキング完了時にチェックボックスで確認
- 出荷完了時に確認ダイアログ表示
- 配送伝票発行中はローディングスピナー表示
- 配送遅延時は注文を赤色でハイライト

## 技術要件

### API仕様

#### エンドポイント: 出荷指示生成
- **メソッド:** POST
- **パス:** `/api/v1/shipments/create-instruction`
- **認証:** Required（倉庫担当者権限）

**リクエスト:**
```json
{
  "orderIds": ["ord_123", "ord_124"]
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "instructions": [
      {
        "instructionId": "inst_001",
        "locationId": "loc_tokyo",
        "orders": ["ord_123"],
        "pickingListUrl": "https://storage.example.com/picking_list_001.pdf"
      }
    ]
  }
}
```

#### エンドポイント: 配送伝票発行
- **メソッド:** POST
- **パス:** `/api/v1/shipments/{shipmentId}/create-label`
- **認証:** Required（倉庫担当者権限）

**リクエスト:**
```json
{
  "carrierId": "carrier_yamato",
  "serviceType": "standard"
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "trackingNumber": "1234-5678-9012",
    "labelUrl": "https://storage.example.com/label_001.pdf",
    "estimatedDeliveryDate": "2025-11-15"
  }
}
```

#### エンドポイント: 出荷完了登録
- **メソッド:** POST
- **パス:** `/api/v1/shipments/{shipmentId}/complete`
- **認証:** Required（倉庫担当者権限）

**リクエスト:**
```json
{
  "shippedAt": "2025-11-12T10:30:00Z"
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "shipmentId": "ship_001",
    "status": "shipped",
    "shippedAt": "2025-11-12T10:30:00Z"
  }
}
```

#### エンドポイント: 配送追跡情報取得
- **メソッド:** GET
- **パス:** `/api/v1/shipments/{shipmentId}/tracking`
- **認証:** Required（JWT、本人または管理者）

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "trackingNumber": "1234-5678-9012",
    "carrier": "ヤマト運輸",
    "currentStatus": "in_transit",
    "estimatedDeliveryDate": "2025-11-15",
    "events": [
      {
        "status": "picked_up",
        "location": "東京配送センター",
        "timestamp": "2025-11-12T12:00:00Z"
      },
      {
        "status": "in_transit",
        "location": "横浜中継センター",
        "timestamp": "2025-11-13T08:00:00Z"
      }
    ]
  }
}
```

### データモデル

#### エンティティ: Shipment
```
Shipment:
- shipmentId: UUID (主キー)
- orderId: UUID (外部キー -> Order)
- locationId: UUID (外部キー -> InventoryLocation)
- carrierCode: String (配送業者コード)
- trackingNumber: String (追跡番号)
- status: Enum (pending, label_created, shipped, in_transit, delivered, failed)
- shippedAt: Timestamp (null可)
- deliveredAt: Timestamp (null可)
- estimatedDeliveryDate: Date
- labelUrl: String (配送ラベルURL)
- createdAt: Timestamp
- updatedAt: Timestamp
```

#### エンティティ: ShipmentItem
```
ShipmentItem:
- shipmentItemId: UUID (主キー)
- shipmentId: UUID (外部キー -> Shipment)
- orderLineId: UUID (外部キー -> OrderLine)
- skuId: UUID (外部キー -> SKU)
- quantity: Integer
```

#### エンティティ: TrackingEvent
```
TrackingEvent:
- eventId: UUID (主キー)
- shipmentId: UUID (外部キー -> Shipment)
- status: Enum (picked_up, in_transit, out_for_delivery, delivered, failed)
- location: String
- description: Text
- eventTimestamp: Timestamp
- createdAt: Timestamp
```

#### エンティティ: CarrierIntegration
```
CarrierIntegration:
- carrierId: UUID (主キー)
- carrierCode: String (一意)
- carrierName: String
- apiEndpoint: String
- apiCredentials: JSONB (暗号化)
- isActive: Boolean
- supportsWebhook: Boolean
- webhookUrl: String (null可)
```

#### リレーションシップ
- Order 1:N Shipment
- Shipment 1:N ShipmentItem
- Shipment 1:N TrackingEvent

### ビジネスルール参照
- BR-SHIP-001: 出荷は在庫引当完了後のみ可能
- BR-SHIP-002: 出荷完了後24時間以内に追跡情報が更新されない場合アラート
- BR-SHIP-003: 配送予定日を過ぎても未配達の場合、自動で顧客サポートに通知

## 依存関係

### 前提条件
- [ ] 注文管理機能が実装済み（US-003）
- [ ] 在庫管理機能が実装済み（US-004）
- [ ] 3PL/配送業者APIのサンドボックス環境が利用可能
- [ ] ストレージサービス（S3等）がPDF保存に利用可能

### 依存するストーリー
- US-003: カート管理と注文確定
- US-004: 在庫管理と在庫ロック機能

### ブロッカー
- 3PL/配送業者との契約とAPI仕様書の入手
- 配送業者ごとのAPIの差異を吸収するアダプタ実装

## テスト戦略

### 単体テスト
- [ ] ピッキングリスト生成ロジック
- [ ] 配送業者APIアダプタ（モック使用）
- [ ] 配送ステータス変換ロジック
- [ ] カバレッジ目標: 85%以上

### 統合テスト
- [ ] 出荷指示生成→配送伝票発行→出荷完了のフロー
- [ ] 3PL APIとの実際の連携（サンドボックス）
- [ ] Webhook受信処理
- [ ] リトライ機構の動作確認

### E2Eテスト
- [ ] 注文確定→出荷指示→配送伝票発行→出荷完了→配送追跡
- [ ] 複数拠点からの分割出荷
- [ ] 配送遅延時のアラート

### 性能テスト
- [ ] 100件の同時出荷指示生成
- [ ] 配送追跡情報の大量取得（1000件）

## 実装計画

### タスク分解
1. [ ] データモデル設計とマイグレーション
   - 見積もり: 6時間
   - 担当: バックエンドエンジニア
2. [ ] 出荷指示生成API実装
   - 見積もり: 10時間
   - 担当: バックエンドエンジニア
3. [ ] 3PL APIアダプタ実装（複数業者対応）
   - 見積もり: 16時間
   - 担当: バックエンドエンジニア
4. [ ] 配送追跡情報取得・更新機構
   - 見積もり: 10時間
   - 担当: バックエンドエンジニア
5. [ ] Webhook受信エンドポイント実装
   - 見積もり: 8時間
   - 担当: バックエンドエンジニア
6. [ ] 出荷遅延検知・アラート機構
   - 見積もり: 6時間
   - 担当: バックエンドエンジニア
7. [ ] 倉庫担当者向けUI実装
   - 見積もり: 12時間
   - 担当: フロントエンドエンジニア
8. [ ] 顧客向け配送追跡UI実装
   - 見積もり: 8時間
   - 担当: フロントエンドエンジニア
9. [ ] テスト実装（単体・統合・E2E）
   - 見積もり: 14時間
   - 担当: QAエンジニア

### 技術的考慮事項
- 3PL APIアダプタはStrategy/Adapterパターンで実装（業者ごとの差異を吸収）
- API呼び出しはサーキットブレーカーパターンで障害対策
- 配送追跡情報はRedisにキャッシュ（1時間TTL）
- Webhook受信時は署名検証でセキュリティ確保
- PDF生成はサーバーサイドで実施（ライブラリ: wkhtmltopdf等）

### リスクと対策
| リスク | 影響度 | 対策 |
|--------|--------|------|
| 3PL API障害 | High | サーキットブレーカー、手動出荷モード、リトライ |
| 配送業者ごとのAPI仕様差異 | Medium | アダプタパターンで統一インターフェース化 |
| Webhook受信の信頼性 | Medium | ポーリングバックアップ、冪等性確保 |
| 出荷遅延の検知漏れ | Medium | 定期バッチジョブで二重チェック |

## 完了の定義（Definition of Done）

- [ ] コードが実装され、レビューが完了している
- [ ] 全ての受入基準が満たされている
- [ ] 単体テストが実装され、全てパスしている（カバレッジ85%以上）
- [ ] 統合テストが実装され、3PL APIサンドボックスで動作確認済み
- [ ] E2Eテストが実装され、全てパスしている
- [ ] セキュリティレビューが完了している
- [ ] API仕様書が更新されている
- [ ] ステージング環境でのテストが完了している
- [ ] プロダクトオーナーによる受入テストが完了している
- [ ] 監視・アラート設定が完了している

## 参考資料

### 関連ドキュメント
- [プロジェクト概要](../project-overview.md)
- [出荷テーブル定義](../data/schema/shipment.sql)

### 外部参照
- [Circuit Breaker Pattern](https://martinfowler.com/bliki/CircuitBreaker.html)
- [Adapter Pattern](https://refactoring.guru/design-patterns/adapter)

## 備考・コメント

### 設計上の決定事項
- 複数3PL業者対応のためアダプタパターン採用
- Webhook + ポーリングのハイブリッド方式で追跡情報更新
- 出荷遅延は自動検知しアラート

### 技術的負債
- 国際配送は将来対応
- 配送保険の自動付与は将来対応
- ドローン配送など新配送手段は将来対応

### 将来の拡張性
- リアルタイム配送地図表示
- 配送品質スコアリング（配送業者の評価）
- 自動配送業者選定（コスト・速度最適化）
- ラストワンマイル配送の自社化

---

## 変更履歴

| 日付 | 変更者 | 変更内容 |
|------|--------|----------|
| 2025-11-11 | AI Assistant | 初版作成 |
