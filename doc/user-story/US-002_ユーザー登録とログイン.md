# ユーザーストーリー：ユーザー登録とログイン

## 基本情報

| 項目 | 内容 |
|------|------|
| **ID** | US-002 |
| **タイトル** | ユーザー登録とログイン機能の実装 |
| **ステータス** | Draft |
| **優先度** | High |
| **見積もり** | 8ストーリーポイント |
| **担当者** | 未割当 |
| **作成日** | 2025-11-11 |
| **更新日** | 2025-11-11 |

## ユーザーストーリー

**As a** 新規ユーザー  
**I want** メールアドレスとパスワードで簡単にアカウントを作成しログインできる  
**So that** 商品を購入し、注文履歴を管理できる

### 日本語記述

新規ユーザーとして、ECサイトで安全に買い物をするために、メールアドレスとパスワードによるアカウント登録とログイン機能が必要である。

## 背景・目的

### ビジネス背景
ファッションECプラットフォームにおいて、ユーザー識別と認証は全ての取引の基盤となる。ユーザーが自身のアカウントを持つことで、注文履歴の追跡、返品・交換の申請、配送先住所の管理などが可能になり、リピート購入率の向上につながる。

### ユーザーニーズ
- 簡単かつ安全にアカウントを作成したい
- 一度登録した情報を再利用して、次回以降スムーズに購入したい
- 自分の注文履歴や配送状況を確認したい
- パスワードを忘れた場合でも簡単に再設定したい

### 現状の課題
- 新規システムのため、ユーザー認証基盤が未構築
- セキュリティ要件（Pマーク準拠、パスワードハッシュ化）を満たす必要がある
- 将来的なOAuth対応やMFA導入を見据えた拡張可能な設計が必要

## 受入基準（Acceptance Criteria）

### 機能要件

#### AC-1: ユーザー新規登録
**Given** 未登録のユーザーが新規登録画面にアクセスする  
**When** メールアドレス、パスワード、名前を入力して登録ボタンを押下する  
**Then** アカウントが作成され、確認メールが送信される

**詳細説明:**
- メールアドレスは一意性チェックが行われる
- パスワードは最低8文字、英大文字・小文字・数字を含む必要がある
- パスワードはArgon2またはPBKDF2でハッシュ化して保存される
- 確認メールにはトークン付きの確認URLが含まれる
- 確認完了までアカウントはアクティブにならない

#### AC-2: メールアドレス確認
**Given** ユーザーが登録後に確認メールを受信する  
**When** メール内の確認リンクをクリックする  
**Then** アカウントがアクティブ化され、ログイン可能になる

**詳細説明:**
- 確認トークンは24時間で期限切れとなる
- 期限切れの場合は再送信が可能
- 確認完了後、自動的にログイン状態になる（オプション）

#### AC-3: ログイン
**Given** 登録済みユーザーがログイン画面にアクセスする  
**When** メールアドレスとパスワードを入力してログインボタンを押下する  
**Then** 認証が成功し、セッションまたはJWTトークンが発行される

**詳細説明:**
- 認証成功時はアクセストークン（有効期限15分）とリフレッシュトークン（有効期限7日）を発行
- ログイン失敗は5回まで。それ以上はアカウントロックアウト（15分間）
- ログイン試行はレート制限される（同一IPから1分間に10回まで）
- ログイン成功/失敗は監査ログに記録される

#### AC-4: パスワードリセット
**Given** ユーザーがパスワードを忘れた  
**When** パスワードリセット画面でメールアドレスを入力する  
**Then** パスワードリセット用のリンクがメールで送信される

**詳細説明:**
- リセットトークンは1時間で期限切れ
- リセットリンクから新しいパスワードを設定できる
- パスワード変更後、既存のセッション/トークンは全て無効化される
- 不正な試行を防ぐため、存在しないメールアドレスでも同じメッセージを返す

#### AC-5: ログアウト
**Given** ログイン中のユーザー  
**When** ログアウトボタンを押下する  
**Then** セッション/トークンが無効化され、ログアウトする

**詳細説明:**
- サーバー側でトークンをブラックリストに追加
- クライアント側でトークンを削除
- ログアウト後はログイン画面にリダイレクト

### 非機能要件

#### パフォーマンス
- [ ] ログインAPIのP95レスポンスタイムは150ms以内
- [ ] トークン検証のP99レスポンスタイムは50ms以内
- [ ] 同時ログイン処理：秒間1000リクエストを処理可能

#### セキュリティ
- [ ] パスワードはArgon2またはPBKDF2でハッシュ化
- [ ] 全ての認証エンドポイントはTLS 1.2+で暗号化
- [ ] JWTトークンはHS256またはRS256で署名
- [ ] CSRF対策（SameSite Cookie、CSRFトークン）
- [ ] レート制限によるブルートフォース攻撃対策
- [ ] 個人情報保護法・Pマーク要件に準拠

#### 可用性
- [ ] 認証サービスのSLA: 99.9%
- [ ] 認証ダウン時の影響を最小化（既存トークンは継続利用可能）

#### 保守性
- [ ] 認証イベント（成功/失敗、パスワード変更）の詳細ログ
- [ ] 異常なログイン試行のアラート（同一IPから短時間に多数の失敗）
- [ ] メトリクス：ログイン成功率、失敗率、レイテンシ

## UI/UX要件

### 画面遷移
```
[新規登録画面] → [メール確認待ち画面] → [メール確認完了] → [ログイン画面] → [ホーム画面]
                                                              ↓
                                                    [パスワードリセット画面]
```

### ワイヤーフレーム
- **新規登録画面**: メールアドレス、パスワード、パスワード確認、名前の入力フィールド
- **ログイン画面**: メールアドレス、パスワードの入力フィールド、「パスワードを忘れた」リンク
- **パスワードリセット画面**: メールアドレス入力フィールド

### インタラクション
- パスワード強度インジケーターをリアルタイム表示
- バリデーションエラーは即座にフィールド下に表示
- ログイン失敗時は「メールアドレスまたはパスワードが正しくありません」と表示（セキュリティのため具体的にどちらが間違っているかは示さない）
- ローディング中はボタンを無効化し、スピナーを表示

## 技術要件

### API仕様

#### エンドポイント: ユーザー登録
- **メソッド:** POST
- **パス:** `/api/v1/auth/register`
- **認証:** 不要

**リクエスト:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123",
  "name": "山田太郎"
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "userId": "usr_123456",
    "email": "user@example.com",
    "emailVerificationRequired": true
  }
}
```

#### エンドポイント: ログイン
- **メソッド:** POST
- **パス:** `/api/v1/auth/login`
- **認証:** 不要

**リクエスト:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123"
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
    "expiresIn": 900,
    "user": {
      "userId": "usr_123456",
      "email": "user@example.com",
      "name": "山田太郎"
    }
  }
}
```

#### エンドポイント: パスワードリセット要求
- **メソッド:** POST
- **パス:** `/api/v1/auth/password-reset`
- **認証:** 不要

**リクエスト:**
```json
{
  "email": "user@example.com"
}
```

**レスポンス（成功時）:**
```json
{
  "status": "success",
  "message": "パスワードリセットのメールを送信しました"
}
```

### データモデル

#### エンティティ: User
```
User:
- userId: UUID (主キー)
- email: String (一意、インデックス)
- passwordHash: String (Argon2/PBKDF2ハッシュ)
- name: String
- emailVerified: Boolean (デフォルト: false)
- isActive: Boolean (デフォルト: true)
- failedLoginAttempts: Integer (デフォルト: 0)
- lockedUntil: Timestamp (null可)
- createdAt: Timestamp
- updatedAt: Timestamp
```

#### エンティティ: EmailVerificationToken
```
EmailVerificationToken:
- tokenId: UUID (主キー)
- userId: UUID (外部キー -> User)
- token: String (一意、インデックス)
- expiresAt: Timestamp
- createdAt: Timestamp
```

#### エンティティ: PasswordResetToken
```
PasswordResetToken:
- tokenId: UUID (主キー)
- userId: UUID (外部キー -> User)
- token: String (一意、インデックス)
- expiresAt: Timestamp
- used: Boolean (デフォルト: false)
- createdAt: Timestamp
```

#### エンティティ: RefreshToken
```
RefreshToken:
- tokenId: UUID (主キー)
- userId: UUID (外部キー -> User)
- token: String (一意、インデックス)
- expiresAt: Timestamp
- revoked: Boolean (デフォルト: false)
- createdAt: Timestamp
```

#### リレーションシップ
- User 1:N EmailVerificationToken
- User 1:N PasswordResetToken
- User 1:N RefreshToken

### ビジネスルール参照
- BR-AUTH-001: パスワードポリシー（最低8文字、複雑性要件）
- BR-AUTH-002: アカウントロックアウトポリシー（5回失敗で15分ロック）
- BR-AUTH-003: トークン有効期限ポリシー（アクセストークン15分、リフレッシュトークン7日）

## 依存関係

### 前提条件
- [ ] データベース（PostgreSQL）環境が構築されている
- [ ] メール送信サービス（SMTP or SES）が設定されている
- [ ] Redis/Memcached（トークンブラックリスト用）が利用可能
- [ ] KMS（Key Management Service）が鍵管理に利用可能

### 依存するストーリー
- なし（最初の基盤ストーリー）

### ブロッカー
- メール送信サービスの選定とセットアップが必要
- JWT署名鍵の生成と安全な保管方法の決定

## テスト戦略

### 単体テスト
- [ ] パスワードハッシュ化・検証ロジック
- [ ] トークン生成・検証ロジック
- [ ] バリデーション（メールフォーマット、パスワード強度）
- [ ] ロックアウトロジック
- [ ] カバレッジ目標: 90%以上

### 統合テスト
- [ ] ユーザー登録からメール確認までのフロー
- [ ] ログイン→トークン発行→API呼び出しのフロー
- [ ] パスワードリセットフロー
- [ ] トークンリフレッシュフロー
- [ ] データベーストランザクションの整合性

### E2Eテスト
- [ ] 新規ユーザーがアカウント作成からログインまで完了できる
- [ ] パスワード忘れから再設定まで完了できる
- [ ] ログイン失敗5回でアカウントロックされる
- [ ] 期限切れトークンでアクセスが拒否される

### 性能テスト
- [ ] ログインAPI: 1000req/sec で P95 < 150ms
- [ ] 同時ログイン: 500並列ユーザーで正常動作
- [ ] レート制限の動作確認

## 実装計画

### タスク分解
1. [ ] データモデル設計とマイグレーション作成
   - 見積もり: 4時間
   - 担当: バックエンドエンジニア
2. [ ] パスワードハッシュ化・検証ロジック実装
   - 見積もり: 4時間
   - 担当: バックエンドエンジニア
3. [ ] ユーザー登録API実装
   - 見積もり: 8時間
   - 担当: バックエンドエンジニア
4. [ ] メール確認機能実装
   - 見積もり: 6時間
   - 担当: バックエンドエンジニア
5. [ ] ログインAPI実装（JWT発行）
   - 見積もり: 8時間
   - 担当: バックエンドエンジニア
6. [ ] パスワードリセット機能実装
   - 見積もり: 6時間
   - 担当: バックエンドエンジニア
7. [ ] レート制限・ロックアウトロジック実装
   - 見積もり: 6時間
   - 担当: バックエンドエンジニア
8. [ ] フロントエンド画面実装（登録・ログイン・リセット）
   - 見積もり: 12時間
   - 担当: フロントエンドエンジニア
9. [ ] テスト実装（単体・統合・E2E）
   - 見積もり: 10時間
   - 担当: QAエンジニア

### 技術的考慮事項
- JWT署名にはRS256（非対称鍵）を推奨（将来的なマイクロサービス化を考慮）
- リフレッシュトークンはデータベースに保存し、失効管理を可能に
- レート制限にはRedisのカウンター機能を活用
- パスワードハッシュにはArgon2（メモリハード関数）を優先検討
- CSRF対策としてSameSite=Strict Cookieを使用

### リスクと対策
| リスク | 影響度 | 対策 |
|--------|--------|------|
| メール送信遅延によるユーザー体験悪化 | Medium | 非同期ジョブキューで送信、リトライ機構実装 |
| ブルートフォース攻撃 | High | レート制限・アカウントロック・CAPTCHA導入検討 |
| トークン漏洩 | High | 短い有効期限、HTTPSのみ、Secure Cookie |
| データベース負荷 | Medium | 認証キャッシュ（Redis）活用、読み取りレプリカ |

## 完了の定義（Definition of Done）

- [ ] コードが実装され、レビューが完了している
- [ ] 全ての受入基準が満たされている
- [ ] 単体テストが実装され、全てパスしている（カバレッジ90%以上）
- [ ] 統合テストが実装され、全てパスしている
- [ ] E2Eテストが実装され、全てパスしている
- [ ] セキュリティレビューが完了している（OWASP Top 10チェック）
- [ ] パフォーマンステストが完了し、SLA基準を満たしている
- [ ] API仕様書が更新されている（OpenAPI/Swagger）
- [ ] ステージング環境でのテストが完了している
- [ ] プロダクトオーナーによる受入テストが完了している
- [ ] 監査ログ・メトリクス・アラート設定が完了している

## 参考資料

### 関連ドキュメント
- [プロジェクト概要](../project-overview.md)
- [データモデル概要](../data/model/data-model-overview.md)
- [ユーザーテーブル定義](../data/schema/user.sql)

### 外部参照
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [JWT Best Practices](https://datatracker.ietf.org/doc/html/rfc8725)
- [Argon2 仕様](https://github.com/P-H-C/phc-winner-argon2)

## 備考・コメント

### 設計上の決定事項
- JWT方式を採用（ステートレス認証でスケーラビリティ向上）
- リフレッシュトークンはDBで管理（失効制御のため）
- メール確認は必須とする（スパム登録防止）

### 技術的負債
- OAuth 2.0対応（Google、Apple等）は将来フェーズで対応
- MFA（多要素認証）は将来フェーズで対応
- ソーシャルログインは将来フェーズで対応

### 将来の拡張性
- OAuth 2.0プロバイダー連携（Google、Apple、LINE等）
- SMS認証の追加
- 生体認証（WebAuthn/FIDO2）対応
- シングルサインオン（SSO）対応

---

## 変更履歴

| 日付 | 変更者 | 変更内容 |
|------|--------|----------|
| 2025-11-11 | AI Assistant | 初版作成 |
