# BR-001: 在庫引当とロック機構

## 基本情報

| 項目 | 内容 |
|------|------|
| **ルールID** | BR-001 |
| **ルール名** | 在庫引当とロック機構 |
| **カテゴリ** | 在庫管理 |

## 概要

### 目的
注文確定時に在庫を確実に引き当て、在庫ロックIDを発行することで、在庫の二重引当を防止し、注文と在庫の整合性を担保する。特にセール時など同時アクセスが多い状況でも、オーバーセル（過剰販売）を防ぐことを目的とする。

### 適用範囲
- 注文確定処理（カートから注文への変換時）
- 在庫引当処理
- 在庫ロック・アンロック処理
- 決済確定時の在庫確保
- 注文キャンセル時の在庫解放

## ルール詳細

### ビジネスルール記述

#### 前提条件
- SKU単位で在庫数が管理されている
- 在庫数はInventoryLocationテーブルに保持されている
- 注文確定前にカート内の商品と数量が確定している
- ユーザーの決済情報が入力済みである

#### ルールステートメント
**IF（条件）**
- ユーザーが注文確定操作を実行する
- カート内の全SKUに対して引き当て可能な在庫が存在する
- 在庫引当処理がタイムアウト内に完了する

**THEN（アクション/結果）**
- 各SKUに対して在庫ロックIDを発行する
- InventoryTransactionテーブルに引当トランザクションを記録する
- 在庫ロックIDを注文レコード（Order/OrderLine）に紐付ける
- 在庫の引当済み数量を更新する（利用可能在庫数を減少させる）
- 注文ステータスを「引当済み」に遷移させる

**ELSE（代替アクション）**
- いずれかのSKUで在庫不足の場合、全SKUの引当処理をロールバックする
- ユーザーに在庫不足エラーメッセージを表示する
- 注文は未確定のまま保持され、カートに戻される
- タイムアウトの場合は一時的なエラーとしてリトライを促す

#### 制約条件
- 在庫引当処理は2秒以内（P99）に完了すること
- 在庫ロックの有効期限は決済完了まで（最大30分）
- 在庫ロック期限切れの場合は自動的に解放される
- 同一SKUへの同時引当リクエストは排他制御される（楽観ロック or 悲観ロック）
- 予約在庫と通常在庫は別管理され、予約注文は予約在庫から優先引当される

### ビジネスロジック

#### 計算式・アルゴリズム
```
利用可能在庫数 = 物理在庫数 - 引当済み数量 - 予約在庫数

在庫引当可否判定:
  IF (利用可能在庫数 >= 注文数量) THEN
    引当可能
  ELSE
    引当不可
  END IF

在庫引当処理:
  1. 対象SKUの在庫レコードを排他ロック取得
  2. 利用可能在庫数をチェック
  3. 引当済み数量を加算（引当済み数量 += 注文数量）
  4. 在庫ロックIDを発行（UUID形式）
  5. InventoryTransactionに記録（タイプ: LOCK, SKU, 数量, ロックID, 注文ID, タイムスタンプ）
  6. コミット
```

#### 判定基準
- 在庫引当の優先順位:
  1. 予約販売の場合: 予約在庫から引当
  2. 通常販売の場合: 先着順で利用可能在庫から引当
  3. 複数拠点がある場合: 配送先に最も近い拠点から優先引当（最適拠点選択）

#### 例外処理
- **在庫不足**: 全SKUの引当をロールバックし、ユーザーに通知
- **タイムアウト**: 処理を中断し、リトライ可能なエラーを返す
- **システムエラー**: トランザクションをロールバックし、エラーログを記録
- **在庫負数検出**: アラートを発行し、管理者に通知（異常として扱う）

## 具体例

### ケース1: 正常系 - 在庫引当成功
**シナリオ:**
ユーザーがセール商品（SKU: SHIRT-001）を2点カートに入れて注文確定を実行する。在庫は十分にある状態。

**入力:**
- SKU: SHIRT-001
- 注文数量: 2
- 物理在庫数: 100
- 引当済み数量: 30
- 予約在庫数: 10

**期待される出力:**
- 利用可能在庫数: 100 - 30 - 10 = 60 → 引当可能
- 在庫ロックID: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
- 引当後の引当済み数量: 32
- 注文ステータス: "引当済み"
- InventoryTransactionレコード作成

### ケース2: 異常系 - 在庫不足
**シナリオ:**
ユーザーが人気商品（SKU: JACKET-002）を5点注文しようとするが、利用可能在庫は3点のみ。

**入力:**
- SKU: JACKET-002
- 注文数量: 5
- 物理在庫数: 50
- 引当済み数量: 45
- 予約在庫数: 2

**期待される出力/エラー:**
- 利用可能在庫数: 50 - 45 - 2 = 3 → 引当不可
- エラーメッセージ: "申し訳ございません。「JACKET-002」の在庫が不足しています。利用可能数量: 3"
- 注文ステータス: 未確定（カートに戻る）
- 引当処理はロールバック

### ケース3: 境界値 - 最後の1点
**シナリオ:**
利用可能在庫がちょうど1点の商品を1点注文する（境界条件）。

**入力:**
- SKU: BAG-003
- 注文数量: 1
- 物理在庫数: 20
- 引当済み数量: 19
- 予約在庫数: 0

**期待される出力:**
- 利用可能在庫数: 20 - 19 - 0 = 1 → 引当可能
- 在庫ロックID発行
- 引当後の引当済み数量: 20
- 利用可能在庫数: 0（完売状態）
- 注文ステータス: "引当済み"

## 関連ルール
- BR-003: 在庫競合制御（同時アクセス時の排他制御）
- BR-006: 決済失敗時の在庫ロールバック
- BR-008: 在庫負数防止ルール

## 備考・補足事項

### 注意事項
- 在庫ロックは一時的な状態であり、決済完了で確定、決済失敗・タイムアウトで解放される
- セール時のピークトラフィックを考慮し、在庫引当処理はスケーラブルに設計すること
- 在庫負数が発生した場合は異常アラートを発行し、即座に調査が必要
- 将来的にオムニチャネル対応（店舗在庫統合）が想定されるため、拡張性を考慮した設計とする
