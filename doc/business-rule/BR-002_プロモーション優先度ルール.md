# BR-002: プロモーション優先度ルール

## 基本情報

| 項目 | 内容 |
|------|------|
| **ルールID** | BR-002 |
| **ルール名** | プロモーション優先度ルール |
| **カテゴリ** | プロモーション |

## 概要

### 目的
同一商品に対して複数のプロモーション（セール、クーポン、タイムセール、予約販売割引など）が適用可能な場合に、どのプロモーションを優先適用するかを明確にし、顧客に対して最適な価格を提示する。また、プロモーションの重複適用や不正利用を防止する。

### 適用範囲
- 商品価格計算処理
- カート金額計算処理
- 注文確定時の価格確定処理
- プロモーション適用判定処理
- 管理画面でのプロモーション設定

## ルール詳細

### ビジネスルール記述

#### 前提条件
- 各プロモーションには優先度（Priority）が設定されている
- プロモーションには開始日時・終了日時が設定されている
- プロモーションには適用条件（対象SKU、最小購入金額、利用回数制限など）が定義されている
- 複数のプロモーションが同時に有効期間内である場合がある

#### ルールステートメント
**IF（条件）**
- 商品に対して複数の有効なプロモーションが存在する
- 各プロモーションの適用条件を満たしている
- プロモーション期間内である

**THEN（アクション/結果）**
- 以下の優先順位でプロモーションを評価する:
  1. **優先度値（Priority）が高いもの**（数値が小さいほど優先度が高い: 1 > 2 > 3）
  2. 同じ優先度の場合は**割引率・割引額が大きいもの**
  3. 同じ割引の場合は**先に作成されたもの**（creation timestamp）
- 最も優先度の高いプロモーションを1つ選択して適用する
- 適用されたプロモーションIDを注文明細に記録する
- 適用されなかったプロモーションは無視される

**ELSE（代替アクション）**
- 有効なプロモーションが存在しない場合は通常価格を適用する
- プロモーション適用条件を満たさない場合はエラーメッセージを表示する
- プロモーション利用回数上限に達している場合は次のプロモーションを評価する

#### 制約条件
- 1つの商品（OrderLine）に対して適用されるプロモーションは1つのみ（重複適用不可）
- ただし、注文全体に対する割引（送料無料など）と商品別割引は併用可能
- プロモーション適用後の価格は0円未満にならない
- クーポンコードは1注文につき1つまで適用可能
- タイムセールは通常セールより優先度が高い

### ビジネスロジック

#### 計算式・アルゴリズム
```
プロモーション選択アルゴリズム:

1. 有効プロモーションリストの取得
   valid_promotions = []
   FOR EACH promotion IN all_promotions:
     IF (current_time >= promotion.start_time AND 
         current_time <= promotion.end_time AND
         promotion.conditions_met(order, sku)) THEN
       valid_promotions.add(promotion)
     END IF
   END FOR

2. 優先度順にソート
   sorted_promotions = SORT(valid_promotions BY:
     1. priority ASC,
     2. discount_value DESC,
     3. created_at ASC
   )

3. 最優先プロモーションを選択
   selected_promotion = sorted_promotions[0]

4. 割引後価格の計算
   IF selected_promotion.type == "PERCENTAGE":
     discounted_price = original_price × (1 - discount_rate)
   ELSE IF selected_promotion.type == "FIXED_AMOUNT":
     discounted_price = original_price - discount_amount
   ELSE IF selected_promotion.type == "FIXED_PRICE":
     discounted_price = fixed_price
   END IF
   
   final_price = MAX(discounted_price, 0)
```

#### 判定基準
- **優先度レベルの定義**:
  - Priority 1: タイムセール（期間限定の特別セール）
  - Priority 2: クーポンコード（個別に発行された割引コード）
  - Priority 3: 予約販売割引（先行予約特典）
  - Priority 4: カテゴリセール（シーズン切替セールなど）
  - Priority 5: 会員ランク割引（通常の会員特典）

- **プロモーション併用ルール**:
  - 商品レベルの割引: 1つのみ適用
  - 注文レベルの割引: 商品割引と併用可能（例: 送料無料）
  - ポイント付与: すべてのプロモーションと併用可能

#### 例外処理
- **プロモーション期限切れ**: カート内の商品が注文確定前に期限切れになった場合、最新の価格を再計算し、ユーザーに通知する
- **在庫制約付きプロモーション**: 割引対象の在庫上限に達している場合、次の優先プロモーションを適用する
- **不正なクーポンコード**: 無効なコードが入力された場合、エラーメッセージを表示し、プロモーション適用なしで処理を継続する
- **システムエラー**: プロモーション計算エラー時は通常価格にフォールバックし、エラーログを記録する

## 具体例

### ケース1: 正常系 - タイムセールが優先適用
**シナリオ:**
商品「COAT-001」に対して、以下の3つのプロモーションが有効期間内に存在する。
1. タイムセール: 40% OFF（Priority 1）
2. カテゴリセール: 20% OFF（Priority 4）
3. 会員ランク割引: 10% OFF（Priority 5）

**入力:**
- 商品価格: 10,000円
- 有効プロモーション: 上記3つすべて条件を満たす
- 現在時刻: 全プロモーション期間内

**期待される出力:**
- 選択されたプロモーション: タイムセール（Priority 1が最優先）
- 割引率: 40%
- 割引後価格: 10,000 × (1 - 0.4) = 6,000円
- 注文明細に記録されるプロモーションID: TIMESALE-20251111

### ケース2: 同じ優先度で割引額が異なる場合
**シナリオ:**
商品「SHOES-002」に対して、同じPriority 2のクーポンが2つ適用可能。

**入力:**
- 商品価格: 8,000円
- クーポンA: 30% OFF（Priority 2, 作成日: 2025-11-01）
- クーポンB: 1,500円 OFF（Priority 2, 作成日: 2025-11-05）
- ユーザーが両方のクーポンを保持している

**期待される出力:**
- クーポンAの割引額: 8,000 × 0.3 = 2,400円
- クーポンBの割引額: 1,500円
- 選択されたクーポン: クーポンA（割引額が大きい）
- 割引後価格: 8,000 - 2,400 = 5,600円

### ケース3: 在庫制約付きプロモーション
**シナリオ:**
タイムセール（先着100名限定）がすでに上限に達している場合。

**入力:**
- 商品価格: 15,000円
- タイムセール: 50% OFF（Priority 1, 残り枠: 0/100）
- カテゴリセール: 25% OFF（Priority 4, 制限なし）

**期待される出力:**
- タイムセールは在庫制約により適用不可
- 次の優先プロモーション（カテゴリセール）を適用
- 割引率: 25%
- 割引後価格: 15,000 × (1 - 0.25) = 11,250円
- ユーザーへの通知: "タイムセールは終了しました。カテゴリセールが適用されます。"

## 関連ルール
- BR-007: カート保持期限ルール（プロモーション期限切れ時の再計算）
- US-005: プロモーション管理機能

## 備考・補足事項

### 注意事項
- プロモーションの優先度設定は管理画面から変更可能とするが、運用ルールで慎重に管理すること
- タイムセール開始・終了時刻はサーバー時刻（JST）を基準とする
- カート内の商品価格は定期的に再計算し、プロモーション期限切れを検出すること
- 将来的にプロモーションの重複適用（例: セール価格からさらにクーポン適用）を許可する可能性があるため、拡張性を考慮した設計とする
