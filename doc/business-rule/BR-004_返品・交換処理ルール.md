# BR-004: 返品・交換処理ルール

## 基本情報

| 項目 | 内容 |
|------|------|
| **ルールID** | BR-004 |
| **ルール名** | 返品・交換処理ルール |
| **カテゴリ** | 返品 |

## 概要

### 目的
顧客からの返品・交換申請を適切に受け付け、倉庫での商品確認、在庫の再登録、返金または再出荷までのワークフローを自動化・支援する。顧客満足度を保ちつつ、不正な返品を防止し、在庫と会計の整合性を維持することが目的。

### 適用範囲
- 返品申請の受付処理
- 交換申請の受付処理
- 倉庫での返品商品確認処理
- 返金処理（決済サービス連携）
- 交換商品の再出荷処理
- 在庫の再登録処理
- 返品・交換履歴の管理

## ルール詳細

### ビジネスルール記述

#### 前提条件
- 商品が配送完了済みであること
- 返品・交換の申請期限内であること（配送完了から30日以内）
- 返品・交換の理由が妥当であること
- ユーザーが認証済みで、注文の所有者であること
- 返品対象商品が返品可能な商品カテゴリであること（一部商品は返品不可）

#### ルールステートメント
**IF（条件）**
- ユーザーが返品・交換申請を実行する
- 申請期限内である（配送完了から30日以内）
- 返品理由が選択されている
- 返品対象商品が返品可能カテゴリである

**THEN（アクション/結果）**
- **返品の場合**:
  1. 返品申請レコードを作成（ステータス: 申請中）
  2. ユーザーに返品ラベル・返送先情報をメール送信
  3. 倉庫に返品予定通知を送信
  4. 商品到着後、倉庫担当者が商品状態を確認
  5. 商品が良好な状態であれば在庫に再登録
  6. 返金処理を実行（決済サービスAPI呼び出し）
  7. ユーザーに返金完了通知を送信
  8. 返品ステータスを「完了」に更新

- **交換の場合**:
  1. 交換申請レコードを作成（ステータス: 申請中）
  2. 交換先商品（サイズ・カラー違い等）の在庫を確認
  3. 在庫がある場合は在庫を引当
  4. ユーザーに返品ラベルと交換商品発送予定をメール送信
  5. 商品到着後、倉庫担当者が商品状態を確認
  6. 商品が良好な状態であれば在庫に再登録
  7. 交換商品を出荷
  8. 交換ステータスを「完了」に更新

**ELSE（代替アクション）**
- 申請期限切れの場合: エラーメッセージを表示（「返品期限を過ぎています」）
- 返品不可商品の場合: エラーメッセージを表示（「この商品は返品対象外です」）
- 交換商品の在庫がない場合: 返品処理に変更するか、入荷待ちを提案
- 商品状態が不良の場合（破損・使用済み等）: 返品拒否、ユーザーに連絡
- 不正な返品の疑いがある場合: 管理者に通知し、手動対応

#### 制約条件
- 返品・交換申請期限: 配送完了から30日以内
- 返品不可商品カテゴリ: セール品（最終価格50%以上割引）、下着、水着、カスタムオーダー商品
- 1つの注文に対して複数の返品・交換申請が可能（商品単位）
- 返品商品は未使用・タグ付き・元の状態を維持していること
- 返金は元の決済方法に対して実行される
- 返金処理は倉庫での商品確認完了後、3営業日以内に実行

### ビジネスロジック

#### 計算式・アルゴリズム
```
返品・交換申請の判定アルゴリズム:

1. 申請期限チェック
   delivery_completed_date = order.delivery_completed_at
   current_date = CURRENT_DATE
   days_elapsed = current_date - delivery_completed_date
   
   IF days_elapsed > 30 THEN
     RETURN error("返品期限を過ぎています")
   END IF

2. 返品可否判定
   IF product.category IN ["下着", "水着", "カスタムオーダー"] THEN
     RETURN error("この商品は返品対象外です")
   END IF
   
   IF product.discount_rate >= 50% THEN
     RETURN error("最終価格品は返品対象外です")
   END IF

3. 返金額の計算
   refund_amount = order_line.paid_amount
   
   # 送料の返金ルール
   IF return_reason == "商品不良" OR return_reason == "誤配送" THEN
     refund_amount += order.shipping_fee
   ELSE
     # 顧客都合の場合、送料は返金しない
   END IF
   
   # ポイント使用分の処理
   IF order.points_used > 0 THEN
     refund_points = order.points_used
     restore_points(user_id, refund_points)
   END IF

4. 在庫再登録の判定
   IF returned_product.condition == "良好" THEN
     inventory.physical_qty += return_qty
     inventory_transaction.create(type: "RETURN", qty: return_qty)
   ELSE IF returned_product.condition == "不良" THEN
     inventory.defective_qty += return_qty
     # 不良品在庫として別管理
   END IF
```

#### 判定基準
- **返品理由のカテゴリ**:
  1. サイズが合わない（顧客都合）
  2. イメージと異なる（顧客都合）
  3. 商品不良・破損（販売者都合）
  4. 誤配送（販売者都合）
  5. その他（フリーテキスト）

- **返品商品の状態判定**:
  - 良好: 未使用、タグ付き、汚れ・破損なし → 在庫再登録
  - 軽微な汚れ: 検品後、状態によっては在庫再登録またはアウトレット移動
  - 不良: 使用済み、タグなし、汚れ・破損あり → 不良在庫として管理、返品拒否の可能性

- **返金スピードの優先度**:
  - 販売者都合（商品不良・誤配送）: 商品到着前に返金処理開始（信頼ベース）
  - 顧客都合: 商品確認完了後に返金処理

#### 例外処理
- **返品商品が届かない**: 一定期間（14日）経過後、返品申請をキャンセル
- **商品状態が著しく悪い**: 返品拒否、ユーザーに連絡して商品返送または廃棄
- **交換商品の在庫切れ**: ユーザーに選択肢を提示（返金、入荷待ち、代替商品）
- **返金処理失敗**: リトライ処理、失敗時は手動対応キューに追加
- **不正返品の疑い**: 管理者に通知、アカウント調査、必要に応じて返品拒否

## 具体例

### ケース1: 正常系 - サイズ違いによる返品
**シナリオ:**
ユーザーがシャツ（SHIRT-001, Lサイズ）を購入したが、サイズが大きすぎたため返品を申請する。

**入力:**
- 注文ID: ORD-20251101-001
- 商品: SHIRT-001 (Lサイズ)
- 配送完了日: 2025-11-01
- 申請日: 2025-11-10（9日後）
- 返品理由: サイズが合わない
- 支払額: 6,000円（送料500円含む）

**期待される出力:**
- 返品申請ID: RET-20251110-001
- ステータス: 申請中
- 返品ラベル発行: ユーザーにメール送信
- 倉庫確認後: 商品状態「良好」
- 在庫再登録: SHIRT-001 (L) の物理在庫 +1
- 返金額: 5,500円（商品代金のみ、送料は返金なし）
- 返金完了通知: ユーザーにメール送信
- 最終ステータス: 完了

### ケース2: 正常系 - 商品不良による交換
**シナリオ:**
ユーザーがジャケット（JACKET-002）を購入したが、ボタンが取れていたため交換を申請する。

**入力:**
- 注文ID: ORD-20251105-002
- 商品: JACKET-002
- 配送完了日: 2025-11-03
- 申請日: 2025-11-06（3日後）
- 交換理由: 商品不良（ボタン欠損）
- 交換希望: 同一商品
- 支払額: 15,000円

**期待される出力:**
- 交換申請ID: EXC-20251106-001
- ステータス: 申請中
- 交換商品在庫確認: JACKET-002 在庫あり
- 在庫引当: JACKET-002 を1点引当
- 返品ラベル発行: ユーザーにメール送信
- 交換商品出荷: 返品到着前に先行出荷（販売者都合のため）
- 倉庫確認後: 不良品を不良在庫として登録
- 返金: なし（交換のため）
- 送料: 販売者負担（往復とも無料）
- 最終ステータス: 完了

### ケース3: 異常系 - 返品期限切れ
**シナリオ:**
ユーザーが商品を購入したが、35日後に返品を申請する。

**入力:**
- 注文ID: ORD-20251001-003
- 商品: COAT-003
- 配送完了日: 2025-10-01
- 申請日: 2025-11-05（35日後）
- 返品理由: イメージと異なる

**期待される出力/エラー:**
- エラーメッセージ: "申し訳ございません。返品期限（配送完了から30日以内）を過ぎています。"
- 返品申請: 作成されない
- ステータス: エラー
- ユーザーへの案内: カスタマーサポートへの問い合わせを促す

### ケース4: 境界値 - 期限ギリギリの返品
**シナリオ:**
配送完了からちょうど30日目に返品申請を行う。

**入力:**
- 配送完了日: 2025-10-11
- 申請日: 2025-11-10（30日目）

**期待される出力:**
- 返品申請: 受付成功（30日以内と判定）
- ステータス: 申請中
- 通常の返品処理フローに進む

## 関連ルール
- BR-006: 決済失敗時の在庫ロールバック（返金処理の逆パターン）
- US-007: 返品・交換管理

## 備考・補足事項

### 注意事項
- 返品・交換処理は顧客満足度に直結するため、迅速かつ丁寧な対応が求められる
- 不正返品（使用済み商品の返品、空箱の返送など）を防止するため、倉庫での厳格な検品が必要
- 返品率が高い商品やユーザーは分析し、商品説明の改善や不正検知に活用する
- 返品処理の自動化により、カスタマーサポートの負担を軽減する
- 将来的に、返品時の配送業者集荷依頼の自動化を検討する
