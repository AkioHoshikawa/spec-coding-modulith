# BR-006: 決済失敗時の在庫ロールバック

## 基本情報

| 項目 | 内容 |
|------|------|
| **ルールID** | BR-006 |
| **ルール名** | 決済失敗時の在庫ロールバック |
| **カテゴリ** | 決済 |
| **優先度** | 高 |
| **作成日** | 2025-11-11 |
| **最終更新日** | 2025-11-11 |
| **作成者** | システムアーキテクト |
| **ステータス** | 提案 |

## 概要

### 目的
決済処理が失敗した場合に、事前に引き当てられた在庫を適切に解放し、在庫の整合性を保つ。決済失敗時の在庫ロールバックを自動化することで、在庫の不必要な拘束を防ぎ、他の顧客が購入できるようにする。また、決済リトライ時の在庫再引当を適切に処理する。

### 適用範囲
- 決済処理の実行
- 決済失敗時の処理
- 在庫ロックの解放処理
- 決済リトライ処理
- 注文ステータスの管理

## ルール詳細

### ビジネスルール記述

#### 前提条件
- 注文確定時に在庫が既に引き当てられている（在庫ロックID発行済み）
- 決済処理は外部決済サービスAPI経由で実行される
- 在庫ロックには有効期限が設定されている
- トランザクション管理が適切に実装されている

#### ルールステートメント
**IF（条件）**
- 決済処理が実行される
- 決済処理が失敗する（カード残高不足、カード無効、通信エラーなど）
- 在庫が既に引き当てられている（在庫ロックIDが存在する）

**THEN（アクション/結果）**
- **決済失敗の種類を判定**:
  1. **一時的エラー**（通信タイムアウト、サービス一時停止など）
     - 在庫ロックを一定期間（例: 15分）保持
     - ユーザーにリトライを促す
     - 自動リトライを3回まで実施
  
  2. **恒久的エラー**（カード無効、残高不足、不正検知など）
     - 在庫ロックを即座に解放
     - 注文ステータスを PAYMENT_FAILED に更新
     - ユーザーに決済失敗通知と対応方法を案内

- **在庫ロールバック処理**:
  1. 在庫ロックIDを使用して引当レコードを特定
  2. 引当済み数量を減算（allocated_qty -= order_qty）
  3. InventoryTransactionにロールバックレコードを記録
  4. 在庫ロックIDを無効化
  5. 監査ログに記録（注文ID、SKU、数量、理由、タイムスタンプ）

- **ユーザー通知**:
  - 決済失敗理由をユーザーにわかりやすく通知
  - 再試行の方法を案内（決済情報修正、別の決済手段）
  - 在庫状況が変わる可能性があることを通知

**ELSE（代替アクション）**
- 決済が成功した場合、在庫ロックを確定状態に遷移
- 注文ステータスを PAYMENT_CONFIRMED に更新
- 在庫ロックの有効期限を無期限に変更（出荷まで保持）

#### 制約条件
- 在庫ロールバックは決済失敗検出後、即座に実行される（目標: 1秒以内）
- 在庫ロールバックはべき等性を保つ（同じリクエストの重複実行でも同じ結果）
- 決済リトライ時は在庫を再引当する（在庫が残っている場合のみ）
- 在庫ロック期限（デフォルト: 30分）を超えた場合は自動的に解放
- ロールバック失敗時はアラートを発行し、手動対応を促す

### ビジネスロジック

#### 計算式・アルゴリズム
```
決済処理フロー:

1. 在庫引当（注文確定時）
   inventory.allocated_qty += order_qty
   lock_id = generate_lock_id()
   inventory_lock.create(lock_id, sku, qty, expires_at: NOW + 30分)

2. 決済処理実行
   payment_result = payment_service.charge(order)
   
   IF payment_result.status == "SUCCESS" THEN
     # 決済成功
     order.status = "PAYMENT_CONFIRMED"
     inventory_lock.confirm(lock_id)  # ロックを確定
     inventory_transaction.create(type: "CONFIRMED", ...)
     
   ELSE IF payment_result.error_type == "TEMPORARY" THEN
     # 一時的エラー（リトライ可能）
     order.status = "PENDING_PAYMENT"
     inventory_lock.extend_expiry(lock_id, 15分)  # 期限延長
     schedule_retry(order, max_retries: 3)
     
   ELSE IF payment_result.error_type == "PERMANENT" THEN
     # 恒久的エラー（リトライ不可）
     rollback_inventory(order, lock_id)
     order.status = "PAYMENT_FAILED"
     notify_user(order, payment_result.error_message)
   END IF

3. 在庫ロールバック処理
   FUNCTION rollback_inventory(order, lock_id):
     BEGIN TRANSACTION
       # 在庫ロックレコードを取得
       lock = inventory_lock.find(lock_id)
       IF lock.status != "RELEASED" THEN
         # 引当数量を減算
         inventory.allocated_qty -= lock.quantity
         
         # トランザクションログ記録
         inventory_transaction.create(
           type: "ROLLBACK",
           sku: lock.sku,
           quantity: -lock.quantity,
           reference_id: order.id,
           reason: "決済失敗"
         )
         
         # ロックステータスを更新
         lock.status = "RELEASED"
         lock.released_at = CURRENT_TIMESTAMP
         
         # 監査ログ
         audit_log.create(
           entity: "Order",
           entity_id: order.id,
           action: "INVENTORY_ROLLBACK",
           details: {lock_id, sku, quantity}
         )
       END IF
     COMMIT

4. 決済リトライ時の在庫再引当
   FUNCTION retry_payment(order):
     # 在庫が残っているか再確認
     available = check_inventory_availability(order.items)
     
     IF available THEN
       # 在庫を再引当
       new_lock_id = allocate_inventory(order.items)
       # 決済再試行
       payment_result = payment_service.charge(order)
       # ...
     ELSE
       # 在庫不足
       order.status = "CANCELLED"
       notify_user(order, "在庫が不足しています")
     END IF
```

#### 判定基準
- **決済エラーの分類**:
  - 一時的エラー: TIMEOUT, SERVICE_UNAVAILABLE, NETWORK_ERROR
  - 恒久的エラー: INSUFFICIENT_FUNDS, INVALID_CARD, FRAUD_DETECTED, CARD_EXPIRED
  - 不明エラー: 一時的エラーとして扱い、リトライする

- **在庫ロック期限**:
  - 初回ロック: 30分
  - リトライ時の延長: 15分ずつ
  - 最大保持時間: 1時間（累計）
  - 期限切れ時: 自動的に在庫ロールバック

#### 例外処理
- **在庫ロールバック失敗**: アラートを発行し、管理者に手動対応を促す
- **決済サービス無応答**: タイムアウト後、一時的エラーとして扱う
- **データ不整合検出**: 在庫ロックIDが見つからない場合、エラーログを記録し、管理者に通知
- **二重ロールバック防止**: 在庫ロックステータスをチェックし、既に解放済みの場合はスキップ

## 具体例

### ケース1: 正常系 - 決済成功
**シナリオ:**
ユーザーが注文を確定し、決済が成功する。

**入力:**
- 注文ID: ORD-20251111-001
- SKU: JACKET-001, 数量: 1
- 在庫ロックID: LOCK-ABC123
- 決済金額: 15,000円

**処理の流れ:**
```
1. 在庫引当: allocated_qty = 10 → 11, lock_id = LOCK-ABC123
2. 決済実行: payment_service.charge() → SUCCESS
3. 在庫ロック確定: lock.status = "CONFIRMED"
4. 注文ステータス: PAYMENT_CONFIRMED
```

**期待される出力:**
- 決済: 成功
- 在庫ロック: 確定済み
- 引当数量: 11のまま保持
- 注文ステータス: PAYMENT_CONFIRMED

### ケース2: 異常系 - カード残高不足による決済失敗
**シナリオ:**
ユーザーが注文を確定したが、カード残高不足で決済が失敗する。

**入力:**
- 注文ID: ORD-20251111-002
- SKU: COAT-002, 数量: 2
- 在庫ロックID: LOCK-DEF456
- 引当前の allocated_qty: 30
- 引当後の allocated_qty: 32
- 決済エラー: INSUFFICIENT_FUNDS

**処理の流れ:**
```
1. 在庫引当: allocated_qty = 30 → 32, lock_id = LOCK-DEF456
2. 決済実行: payment_service.charge() → FAILURE (INSUFFICIENT_FUNDS)
3. エラー分類: 恒久的エラー
4. 在庫ロールバック実行:
   - allocated_qty = 32 → 30
   - lock.status = "RELEASED"
   - inventory_transaction.create(type: "ROLLBACK", qty: -2)
5. 注文ステータス: PAYMENT_FAILED
6. ユーザー通知: "決済に失敗しました。カード残高をご確認ください。"
```

**期待される出力:**
- 決済: 失敗
- 在庫ロック: 解放済み
- 引当数量: 30に戻る（ロールバック成功）
- 注文ステータス: PAYMENT_FAILED
- ユーザー通知: 送信済み

### ケース3: 一時的エラーからのリトライ成功
**シナリオ:**
決済サービスの一時的な障害で決済が失敗したが、自動リトライで成功する。

**入力:**
- 注文ID: ORD-20251111-003
- SKU: SHIRT-003, 数量: 3
- 在庫ロックID: LOCK-GHI789
- 決済エラー（1回目）: TIMEOUT

**処理の流れ:**
```
1. 在庫引当: allocated_qty += 3, lock_id = LOCK-GHI789
2. 決済実行（1回目）: TIMEOUT
3. エラー分類: 一時的エラー
4. 在庫ロック期限延長: expires_at = NOW + 15分
5. リトライスケジュール: 100ms後
6. 決済実行（2回目）: SUCCESS
7. 在庫ロック確定: lock.status = "CONFIRMED"
8. 注文ステータス: PAYMENT_CONFIRMED
```

**期待される出力:**
- 決済: 2回目で成功
- 在庫ロック: 確定済み（解放されず）
- 引当数量: +3のまま保持
- 注文ステータス: PAYMENT_CONFIRMED

### ケース4: リトライ中の在庫切れ
**シナリオ:**
決済リトライ中に他のユーザーが同じ商品を購入し、在庫が不足する。

**入力:**
- 注文ID: ORD-20251111-004
- SKU: LIMITED-ITEM, 利用可能在庫: 1点
- 決済エラー（1回目）: TIMEOUT
- リトライ待機中に別注文が確定し、在庫がゼロになる

**処理の流れ:**
```
1. 在庫引当: 1点引当成功
2. 決済実行（1回目）: TIMEOUT
3. 在庫ロック一時保持（15分）
4. [別ユーザーが在庫ロック期限切れを待ち、在庫を取得]
5. リトライ時（15分後）: 在庫ロック期限切れ、自動解放済み
6. 再引当試行: 在庫不足エラー
7. 注文ステータス: CANCELLED
8. ユーザー通知: "申し訳ございません。在庫が不足しています。"
```

**期待される出力:**
- 決済: 実行されず
- 在庫ロック: 期限切れで自動解放
- 注文ステータス: CANCELLED
- ユーザー通知: 在庫切れの案内

## 関連ルール
- BR-001: 在庫引当とロック機構
- BR-005: 注文ステータス遷移ルール
- BR-003: 在庫競合制御

## 備考・補足事項

### 注意事項
- 決済処理は外部サービスに依存するため、タイムアウトやリトライの設定を適切に行うこと
- 在庫ロールバックの失敗は重大な問題であり、即座にアラートを発行し、手動対応を行うこと
- 決済リトライの回数・間隔は、ユーザー体験と在庫効率のバランスを考慮して設定する
- 将来的に複数決済手段（クレジットカード、電子マネー、後払いなど）に対応する場合、各手段ごとのエラーハンドリングを定義する
- 決済処理のログは詳細に記録し、トラブルシューティングや監査に活用する

### 参照ドキュメント
- プロジェクト概要: `doc/project-overview.md`
- ユーザーストーリー: `US-003_カート管理と注文確定.md`
- 外部連携: 決済サービスAPI仕様書
- インシデント対応手順: 在庫ロールバック失敗時の対応フロー
