# BR-007: カート保持期限ルール

## 基本情報

| 項目 | 内容 |
|------|------|
| **ルールID** | BR-007 |
| **ルール名** | カート保持期限ルール |
| **カテゴリ** | 注文処理 |
| **優先度** | 中 |
| **作成日** | 2025-11-11 |
| **最終更新日** | 2025-11-11 |
| **作成者** | システムアーキテクト |
| **ステータス** | 提案 |

## 概要

### 目的
カートに商品を追加した状態で長時間放置されると、プロモーション期限切れや在庫変動により価格・在庫状況が変わる可能性がある。カート保持期限を設定することで、在庫の不必要な拘束を防ぎ、価格情報の鮮度を保ち、ユーザーに正確な情報を提供する。また、システムリソースの効率的な利用を図る。

### 適用範囲
- カートの作成・更新処理
- カート内商品の価格・在庫チェック
- カート期限切れ時の自動削除処理
- プロモーション適用の再計算
- 注文確定時のカート検証

## ルール詳細

### ビジネスルール記述

#### 前提条件
- カートレコードには最終更新日時（last_updated_at）が記録されている
- カート内の各商品にはプロモーション情報が紐付いている
- バックグラウンドジョブでカート期限切れチェックが定期実行される
- ユーザーがログインしている場合とゲストの場合でカート保持方法が異なる

#### ルールステートメント
**IF（条件）**
- カートが作成または更新されてから一定期間（デフォルト: 7日間）が経過している
- ユーザーがカート内容を確認または注文確定を試みる
- または、定期バッチ処理で期限切れカートがチェックされる

**THEN（アクション/結果）**
- **カート期限切れの場合**:
  1. カートステータスを「期限切れ」に更新
  2. カート内の商品情報を削除（またはアーカイブ）
  3. ユーザーに期限切れ通知を送信（ログインユーザーの場合）
  4. 次回アクセス時に空のカートを表示

- **カート期限内の場合**:
  1. カート内の商品価格・プロモーションを再計算
  2. 在庫状況を再確認
  3. 変更があればユーザーに通知（価格変更、在庫切れなど）
  4. 最新情報でカートを表示

- **注文確定時のカート検証**:
  1. カート期限内であることを確認
  2. 商品の価格・プロモーションが最新であることを確認
  3. 在庫が利用可能であることを確認
  4. 問題がなければ注文処理を続行

**ELSE（代替アクション）**
- カートが期限切れかつ注文確定を試みた場合: エラーメッセージを表示し、カートを再作成させる
- 在庫切れが検出された場合: 該当商品をカートから削除し、ユーザーに通知
- プロモーション期限切れの場合: 価格を再計算し、ユーザーに通知

#### 制約条件
- **カート保持期限**:
  - ログインユーザー: 7日間
  - ゲストユーザー: セッション有効期間内（最大24時間）
  - タイムセール商品を含む場合: タイムセール終了時刻まで（最短）

- **価格再計算のタイミング**:
  - カート表示時
  - カート商品追加・更新時
  - 注文確定時（最終確認）

- **期限切れカートの削除**:
  - バッチ処理で毎日深夜に実行
  - 期限切れから30日経過したカートは完全削除
  - 期限切れ～30日以内はアーカイブとして保持（分析用）

### ビジネスロジック

#### 計算式・アルゴリズム
```
カート期限チェック:

FUNCTION is_cart_expired(cart):
  current_time = CURRENT_TIMESTAMP
  
  # ログインユーザーの場合
  IF cart.user_id IS NOT NULL THEN
    expiry_duration = 7日間
  ELSE
    # ゲストユーザーの場合
    expiry_duration = 24時間
  END IF
  
  # タイムセール商品を含む場合
  IF cart.has_time_sale_items THEN
    time_sale_end = get_earliest_time_sale_end(cart)
    expiry_time = MIN(cart.last_updated_at + expiry_duration, time_sale_end)
  ELSE
    expiry_time = cart.last_updated_at + expiry_duration
  END IF
  
  IF current_time > expiry_time THEN
    RETURN true  # 期限切れ
  ELSE
    RETURN false  # 期限内
  END IF


価格・プロモーション再計算:

FUNCTION refresh_cart_prices(cart):
  changes = []
  
  FOR EACH item IN cart.items:
    # 最新の商品価格を取得
    current_price = get_product_price(item.sku)
    
    # 最新のプロモーションを取得
    current_promotion = get_best_promotion(item.sku)
    
    # 価格変更をチェック
    IF item.price != current_price OR item.promotion_id != current_promotion.id THEN
      old_price = item.price
      new_price = apply_promotion(current_price, current_promotion)
      
      # 変更を記録
      changes.add({
        sku: item.sku,
        old_price: old_price,
        new_price: new_price,
        reason: "価格またはプロモーションが変更されました"
      })
      
      # カート内の価格を更新
      item.price = new_price
      item.promotion_id = current_promotion.id
    END IF
    
    # 在庫チェック
    available = check_inventory(item.sku, item.quantity)
    IF NOT available THEN
      changes.add({
        sku: item.sku,
        reason: "在庫が不足しています",
        action: "カートから削除"
      })
      cart.items.remove(item)
    END IF
  END FOR
  
  IF changes.length > 0 THEN
    notify_user(cart.user_id, changes)
  END IF
  
  cart.last_updated_at = CURRENT_TIMESTAMP
  RETURN cart


バッチ処理（期限切れカート削除）:

FUNCTION cleanup_expired_carts():
  expired_carts = SELECT * FROM carts 
                  WHERE status = 'ACTIVE'
                    AND is_cart_expired(cart) = true
  
  FOR EACH cart IN expired_carts:
    # カートを期限切れステータスに更新
    cart.status = 'EXPIRED'
    cart.expired_at = CURRENT_TIMESTAMP
    
    # ログインユーザーに通知
    IF cart.user_id IS NOT NULL THEN
      send_notification(cart.user_id, "カートの有効期限が切れました")
    END IF
    
    # アーカイブ
    archive_cart(cart)
  END FOR
  
  # 30日以上前に期限切れになったカートを完全削除
  old_expired_carts = SELECT * FROM carts
                      WHERE status = 'EXPIRED'
                        AND expired_at < CURRENT_TIMESTAMP - 30日間
  
  FOR EACH cart IN old_expired_carts:
    delete_cart(cart)
  END FOR
```

#### 判定基準
- **カート期限の分類**:
  - 通常カート（ログインユーザー）: 7日間
  - ゲストカート: 24時間
  - タイムセール商品含む: タイムセール終了時刻（優先）

- **価格変更時の通知レベル**:
  - 値上がり: 赤色の警告通知
  - 値下がり: 緑色の情報通知
  - 在庫切れ: 赤色のエラー通知

#### 例外処理
- **注文確定直前の期限切れ**: エラーメッセージを表示し、カートを再作成させる
- **価格再計算エラー**: 元の価格を維持し、エラーログを記録、管理者に通知
- **在庫チェックエラー**: 保守的に「在庫不足」として扱い、ユーザーに確認を促す
- **通知送信失敗**: ログに記録し、次回ログイン時にダッシュボードで通知

## 具体例

### ケース1: 正常系 - カート期限内の価格変更
**シナリオ:**
ユーザーがカートに商品を追加後、3日後にカートを確認する。その間にプロモーションが変更されている。

**入力:**
- カート作成日時: 2025-11-01 10:00
- 商品: JACKET-001
- カート作成時の価格: 20,000円（プロモーション: 20% OFF）
- カート確認日時: 2025-11-04 15:00（3日後）
- 最新の価格: 20,000円（プロモーション: 30% OFF）

**期待される出力:**
- カート期限: 期限内（7日以内）
- 価格再計算実行:
  - 旧価格: 20,000 × 0.8 = 16,000円
  - 新価格: 20,000 × 0.7 = 14,000円
- ユーザー通知: "「JACKET-001」の価格が変更されました。16,000円 → 14,000円"
- カート表示: 更新後の価格（14,000円）

### ケース2: 異常系 - カート期限切れ
**シナリオ:**
ユーザーがカートに商品を追加したまま10日間放置し、久しぶりにアクセスする。

**入力:**
- カート作成日時: 2025-11-01 10:00
- 商品: COAT-002, SHOES-003
- カート確認日時: 2025-11-11 15:00（10日後）
- ユーザー種別: ログインユーザー

**期待される出力:**
- カート期限: 期限切れ（7日を超過）
- カートステータス: ACTIVE → EXPIRED
- カート内容: 削除（アーカイブ）
- ユーザー通知: "カートの有効期限が切れたため、カート内の商品が削除されました。"
- カート表示: 空のカート

### ケース3: タイムセール商品の期限切れ
**シナリオ:**
タイムセール商品（23:59まで）をカートに追加し、タイムセール終了後にカートを確認する。

**入力:**
- カート作成日時: 2025-11-11 23:00
- 商品: TIMESALE-ITEM（タイムセール: 23:59まで）
- タイムセール価格: 10,000円（通常価格: 15,000円）
- カート確認日時: 2025-11-12 00:30（タイムセール終了後）

**期待される出力:**
- カート期限: タイムセール終了により部分的に期限切れ
- 価格再計算実行:
  - 旧価格: 10,000円（タイムセール）
  - 新価格: 15,000円（通常価格）
- ユーザー通知: "タイムセールが終了したため、「TIMESALE-ITEM」の価格が変更されました。10,000円 → 15,000円"
- カート表示: 更新後の価格（15,000円）
- カート自体は削除されない（7日以内のため）

### ケース4: 注文確定時の在庫切れ検出
**シナリオ:**
カートに商品を追加後、注文確定を試みるが、その間に在庫が売り切れている。

**入力:**
- カート作成日時: 2025-11-11 14:00
- 商品: LIMITED-ITEM（数量: 1）
- 注文確定日時: 2025-11-11 15:00
- カート作成時の在庫: あり
- 注文確定時の在庫: なし（他のユーザーが購入）

**期待される出力:**
- カート期限: 期限内
- 在庫チェック実行: 在庫不足を検出
- エラーメッセージ: "申し訳ございません。「LIMITED-ITEM」の在庫が不足しています。"
- カートから該当商品を削除
- 注文確定: 失敗（カート内容の再確認を促す）

## 関連ルール
- BR-002: プロモーション優先度ルール（価格再計算時のプロモーション適用）
- BR-001: 在庫引当とロック機構（注文確定時の在庫チェック）
- BR-005: 注文ステータス遷移ルール（カートから注文への遷移）

## 備考・補足事項

### 注意事項
- カート期限は顧客体験とシステムリソースのバランスを考慮して設定する
- タイムセールなど期間限定プロモーションの場合、カート保持期限よりプロモーション終了時刻を優先する
- ゲストユーザーのカートはブラウザCookieまたはセッションストレージに保持されるため、ブラウザを変えるとアクセスできなくなる
- 将来的にカート保持期限をユーザーが設定できる機能を検討する（例: 「ウィッシュリスト」として長期保存）
- カート期限切れカートの分析により、離脱理由（価格、送料、決済方法など）を特定し、改善に活用する

### 参照ドキュメント
- プロジェクト概要: `doc/project-overview.md`
- ユーザーストーリー: `US-003_カート管理と注文確定.md`
- データモデル: Cartテーブル、CartItemテーブル定義
- 運用手順: バッチ処理スケジュール設定
