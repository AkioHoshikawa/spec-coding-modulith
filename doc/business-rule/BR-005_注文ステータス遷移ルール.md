# BR-005: 注文ステータス遷移ルール

## 基本情報

| 項目 | 内容 |
|------|------|
| **ルールID** | BR-005 |
| **ルール名** | 注文ステータス遷移ルール |
| **カテゴリ** | 注文処理 |

## 概要

### 目的
注文のライフサイクル全体を通じて、ステータスの遷移を明確に定義し、システムの一貫性を保つ。不正な状態遷移を防止し、各ステータスにおける許可された操作を制限することで、データ整合性とビジネスロジックの正確性を担保する。

### 適用範囲
- 注文作成から完了・キャンセルまでの全プロセス
- 注文ステータスの更新処理
- ステータスに応じた操作制限
- 管理画面での注文管理
- 外部システム（3PL、決済サービス）との連携時のステータス同期

## ルール詳細

### ビジネスルール記述

#### 前提条件
- 注文レコード（Order）にステータスフィールド（status）が存在する
- ステータス遷移は監査ログに記録される
- ステータス変更は許可されたトランザクション内でのみ実行される
- 各ステータスに対応するビジネスロジックが実装されている

#### ルールステートメント
**IF（条件）**
- 注文のステータス変更が要求される
- 変更先のステータスが現在のステータスから遷移可能である
- 遷移に必要な前提条件が満たされている

**THEN（アクション/結果）**
- ステータスを変更する
- ステータス変更イベントを発行する
- 関連する処理を実行する（在庫更新、通知送信など）
- 監査ログに記録する（変更前ステータス、変更後ステータス、変更理由、タイムスタンプ、実行者）

**ELSE（代替アクション）**
- 不正な遷移の場合、エラーを返す
- 前提条件が満たされていない場合、エラーを返す
- 監査ログに失敗記録を残す

#### 制約条件
- ステータスの逆戻り（例: 出荷済み → 引当済み）は原則禁止
- 例外的な逆戻りは管理者権限でのみ実行可能
- キャンセル処理は特定のステータスからのみ実行可能
- 完了状態からの変更は不可（返品は別フローで処理）
- ステータス変更は必ずトランザクション内で実行する

### ビジネスロジック

#### ステータス定義と遷移フロー
```
注文ステータスの定義:

1. CART (カート)
   - 説明: ユーザーがカートに商品を追加した状態（注文未確定）
   - 次の状態: PENDING_PAYMENT, CANCELLED

2. PENDING_PAYMENT (決済待ち)
   - 説明: 注文確定ボタンが押され、決済処理待ちの状態
   - 次の状態: PAYMENT_CONFIRMED, PAYMENT_FAILED, CANCELLED

3. PAYMENT_CONFIRMED (決済確定)
   - 説明: 決済が完了し、在庫引当待ちの状態
   - 次の状態: ALLOCATED, CANCELLED

4. ALLOCATED (引当済み)
   - 説明: 在庫が引き当てられ、出荷準備待ちの状態
   - 次の状態: PREPARING_SHIPMENT, CANCELLED

5. PREPARING_SHIPMENT (出荷準備中)
   - 説明: 倉庫でピッキング・梱包中の状態
   - 次の状態: SHIPPED, CANCELLED

6. SHIPPED (出荷済み)
   - 説明: 配送業者に引き渡し済み、配送中の状態
   - 次の状態: DELIVERED, DELIVERY_FAILED

7. DELIVERED (配送完了)
   - 説明: 顧客に商品が配送完了した状態
   - 次の状態: COMPLETED

8. COMPLETED (完了)
   - 説明: 注文が完全に完了した状態（返品期限経過後など）
   - 次の状態: なし（最終状態）

9. CANCELLED (キャンセル)
   - 説明: 注文がキャンセルされた状態
   - 次の状態: なし（最終状態）

10. PAYMENT_FAILED (決済失敗)
    - 説明: 決済処理が失敗した状態
    - 次の状態: PENDING_PAYMENT（再試行）, CANCELLED

11. DELIVERY_FAILED (配送失敗)
    - 説明: 配送に失敗した状態（不在、住所不明など）
    - 次の状態: SHIPPED（再配達）, RETURNED_TO_SENDER
```

#### 遷移ルールのマトリクス
```
from状態 → to状態: 条件

CART → PENDING_PAYMENT: ユーザーが注文確定ボタンを押す
CART → CANCELLED: ユーザーがカートを削除 or タイムアウト

PENDING_PAYMENT → PAYMENT_CONFIRMED: 決済処理成功
PENDING_PAYMENT → PAYMENT_FAILED: 決済処理失敗
PENDING_PAYMENT → CANCELLED: ユーザーがキャンセル or タイムアウト

PAYMENT_CONFIRMED → ALLOCATED: 在庫引当処理成功
PAYMENT_CONFIRMED → CANCELLED: 在庫引当失敗 or ユーザーキャンセル

ALLOCATED → PREPARING_SHIPMENT: 出荷指示が倉庫に送信される
ALLOCATED → CANCELLED: ユーザーキャンセル（決済返金あり）

PREPARING_SHIPMENT → SHIPPED: 配送業者に引き渡し完了
PREPARING_SHIPMENT → CANCELLED: ユーザーキャンセル（緊急対応）

SHIPPED → DELIVERED: 配送完了確認
SHIPPED → DELIVERY_FAILED: 配送失敗（不在、住所不明など）

DELIVERED → COMPLETED: 返品期限経過 or 返品なし確定
DELIVERY_FAILED → SHIPPED: 再配達手配
DELIVERY_FAILED → RETURNED_TO_SENDER: 配送中止、返送

PAYMENT_FAILED → PENDING_PAYMENT: ユーザーが決済情報を修正して再試行
PAYMENT_FAILED → CANCELLED: 再試行なくキャンセル
```

#### ステータス別の許可操作
```
CART:
  - カート内容編集（商品追加・削除・数量変更）
  - 注文確定
  - カート削除

PENDING_PAYMENT:
  - 決済実行
  - キャンセル

PAYMENT_CONFIRMED, ALLOCATED:
  - ユーザーによるキャンセル（在庫解放、返金処理）
  - 管理者による注文修正（制限付き）

PREPARING_SHIPMENT:
  - 緊急キャンセル（要管理者承認）

SHIPPED:
  - 配送追跡情報の参照
  - 配送先変更（配送業者が対応可能な場合）

DELIVERED, COMPLETED:
  - 返品申請（別フロー）
  - 領収書再発行

CANCELLED, PAYMENT_FAILED:
  - 参照のみ（変更不可）
```

#### 例外処理
- **不正な遷移要求**: エラーを返し、監査ログに記録
- **システムエラー**: トランザクションをロールバックし、元のステータスを維持
- **外部システム連携エラー**: リトライキューに追加し、一時的に中間ステータスを保持
- **緊急キャンセル**: 管理者権限で特定のステータスから強制キャンセルを許可（例外対応）

## 具体例

### ケース1: 正常系 - 通常の注文フロー
**シナリオ:**
ユーザーが商品を購入し、配送完了まで進む通常のフロー。

**入力:**
- 初期ステータス: CART
- 操作シーケンス:
  1. ユーザーが注文確定
  2. 決済処理成功
  3. 在庫引当成功
  4. 倉庫が出荷準備開始
  5. 配送業者に引き渡し
  6. 配送完了

**期待される出力（ステータス遷移）:**
```
CART 
  → PENDING_PAYMENT (注文確定)
  → PAYMENT_CONFIRMED (決済成功)
  → ALLOCATED (在庫引当成功)
  → PREPARING_SHIPMENT (出荷準備開始)
  → SHIPPED (配送業者引き渡し)
  → DELIVERED (配送完了)
  → COMPLETED (30日後、返品なし)
```
- 各遷移で監査ログが記録される
- ユーザーに各段階で通知メールが送信される

### ケース2: 異常系 - 決済失敗からのリカバリ
**シナリオ:**
決済処理が失敗し、ユーザーが決済情報を修正して再試行する。

**入力:**
- 初期ステータス: PENDING_PAYMENT
- 操作: 決済処理実行 → 失敗（カード残高不足）
- 再操作: 別のカードで再試行 → 成功

**期待される出力:**
```
PENDING_PAYMENT
  → PAYMENT_FAILED (決済失敗)
  → PENDING_PAYMENT (ユーザーが決済情報修正)
  → PAYMENT_CONFIRMED (再試行成功)
  → ... (通常フローに復帰)
```
- 決済失敗時、在庫ロックは解放されない（一定期間保持）
- ユーザーに決済失敗通知と再試行の案内を送信

### ケース3: ユーザーによるキャンセル
**シナリオ:**
ユーザーが出荷準備前に注文をキャンセルする。

**入力:**
- 現在ステータス: ALLOCATED
- 操作: ユーザーがキャンセルボタンをクリック

**期待される出力:**
```
ALLOCATED
  → CANCELLED (ユーザーキャンセル)
```
- 在庫ロックを即座に解放
- 決済済みの場合、返金処理を開始
- ユーザーにキャンセル完了通知を送信
- 監査ログにキャンセル理由を記録

### ケース4: 不正な遷移の拒否
**シナリオ:**
システムのバグまたは不正な操作により、出荷済み状態から引当済み状態への遷移が試行される。

**入力:**
- 現在ステータス: SHIPPED
- 試行された遷移: SHIPPED → ALLOCATED

**期待される出力/エラー:**
- エラーメッセージ: "不正なステータス遷移です。SHIPPED から ALLOCATED への遷移は許可されていません。"
- ステータス変更: 実行されない（SHIPPEDのまま）
- 監査ログ: 失敗記録を保存（試行された遷移、実行者、タイムスタンプ）
- アラート: システム管理者に異常通知

## 関連ルール
- BR-001: 在庫引当とロック機構（ALLOCATED状態への遷移時）
- BR-006: 決済失敗時の在庫ロールバック（PAYMENT_FAILED状態への遷移時）
- BR-004: 返品・交換処理ルール（DELIVERED/COMPLETED状態からの別フロー）

## 備考・補足事項

### 注意事項
- ステータス遷移ロジックは一箇所に集約し、各所で独自にステータス更新を行わないこと（状態管理の一元化）
- 外部システム（3PL、配送業者）からのステータス更新は非同期で処理し、整合性チェックを実施すること
- ステータス遷移時にイベント駆動アーキテクチャを採用することで、拡張性と疎結合を実現する
- 将来的に新しいステータス（例: PARTIALLY_SHIPPED）を追加する可能性を考慮し、拡張可能な設計とする
- ステータス遷移の失敗率・遅延を監視し、ボトルネックを早期に検出すること
