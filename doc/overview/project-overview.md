
# ファッションECの受注〜出荷プラットフォーム

## 1. 背景
近年、ファッションECは頻繁なプロモーション、予約販売、シーズン切替による在庫変動が激しく、注文ピーク時の同時アクセスや在庫競合への対応が運営上の課題となっている。本プロジェクトは、マーケティング施策（セール、タイムセール、予約販売等）を短いサイクルで実行しつつ、受注から在庫引当、出荷指示までを信頼性高く自動化するプラットフォームを構築することを目的とする。

本サービスは国内ユーザーが主であり、返品・交換、店舗在庫の併用（オムニチャネル）、および顧客対応（コールセンター・チャット）との連携が重要である。

## 2. 目的（ゴール）
- マーケティング施策を遅延なく反映できる受注処理基盤を構築する
- ピーク時（秒間数千リクエスト想定）でも在庫整合性を保ちつつ受注を確定できること
- 返品・交換・キャンセルの業務フローを実運用に即した形で支援する
- 既存の物流（3PL）・会計・ERP と柔軟に連携できるインタフェースを用意する

## 3. スコープ
### インスコープ（本フェーズ）
- ユーザー向けの受注フロー（カート→注文確定）
- プロモーション（クーポン・割引・タイムセール・予約販売）対応
- リアルタイム在庫引当と在庫ロック機構
- 注文ステータス管理（受注、引当、出荷、配送、完了、キャンセル）
- 返品・交換申請ワークフロー
- 3PL・配送業者とのAPI連携（出荷指示、配送追跡）
- 管理画面（注文一覧、在庫状況、プロモーション管理の基本）
 - ログイン／アカウント管理（ユーザー登録、認証、プロフィール管理、住所帳、注文履歴の参照）

### アウトオブスコープ（このフェーズでは実施しない）
- POSや店舗の詳細オムニチャネル統合（簡易的な在庫参照は可）
- 会計仕訳の自動投入（エクスポートのみ提供）
- 高度なレコメンデーション／AIレコメンド機能

## 4. ハイレベル機能要件
1. 注文処理
	- カート作成、複数配送先、ギフトオプション
	- 注文確定時に在庫をロックし、支払い確定・与信取り消し等に対応
2. プロモーション管理
	- セール開始・終了のスケジュール、在庫制約付き割引、予約販売の在庫先行割当
	- 同一商品に対する複数プロモーションルールの優先度付け
3. 在庫管理
	- SKU単位の在庫数管理、入出庫履歴の保持
	- 在庫引当アルゴリズム（先着、最適拠点選択、予約在庫）
	- 在庫のコンカレンシー対策（分散ロック、楽観ロック、原子操作）
4. 認証・アカウント管理
	- ユーザー登録・ログイン
		- メールアドレス／パスワードによるアカウント登録とログイン
		- OAuth 2.0 / OpenID Connect による外部プロバイダ（例：Google, Apple）のログイン対応（オプション）
		- パスワードリセット（メールベースのトークン発行）とメール確認フロー
	- アカウント管理
		- プロファイル編集（名前、連絡先、複数配送先住所の管理）
		- メールアドレス・電話番号の検証と変更手続き
		- 注文履歴、返品・交換履歴の表示権限
	- セキュリティ要件
		- セッション管理（JWTやセッションクッキー等の選択肢と安全な設定）
		- 多要素認証（MFA）の将来的な有効化を見据えた設計
		- レートリミット・不正ログイン検知、ロックアウトポリシー
		- 個人情報保護（パスワードはPBKDF2/Argon2等でハッシュ化、Pマーク/関連法令準拠）
	- 権限・認可（簡易）
		- 管理者用の権限スコープ（管理画面アクセス）と一般ユーザーの分離
		- APIアクセスのためのアクセストークンライフサイクル管理

4. 出荷・物流連携
	- 出荷指示・ピッキングリストの生成
	- 3PL/API連携による配送伝票発行と追跡
5. 返品・交換
	- 返品申請→倉庫確認→返金/再出荷の自動化支援
6. 管理機能
	- 注文監査ログ、操作ログ、異常アラート（在庫負数、配送遅延）

## 5. 非機能要件
- パフォーマンス：ピーク時における注文確定のP99が2秒以内（読み取り多数、書き込み高負荷の設計）
- スケーラビリティ：横方向スケール可能な設計（ステートレスAPIと外部DB/キャッシュ利用）
- 可用性：24/7運用想定で、計画外ダウンタイムを年間数時間に抑える（SLA目標 99.9%）
- 一貫性：在庫数は業務上の必須整合性を担保（最終的整合性ではなく、重要な在庫引当は強整合）
- セキュリティ：個人情報保護（Pマークに準拠想定）、決済情報はPCI-DSSに基づきトークン化
- 運用性：運用者向けダッシュボード、バッチ監視、ジョブ再実行機構を整備
- ログ・監査：注文操作の完全監査ログを保持（少なくとも1年）

- 認証・認可（非機能要件）:
	- 可用性とスケール：認証サービスは独立して水平スケール可能とし、認証の遅延が主系APIのP99に与える影響を最小限にする（認証P99目標 200ms 以下を目安）
	- セッション／トークンライフサイクル：アクセストークン短寿命（例：15分）、リフレッシュトークンの安全な保存・失効機構を設計すること
	- レスポンスタイム：ログイン・トークン検証など認証APIのP95は150ms以内を目標とする
	- 可観測性：失敗率、レイテンシ、異常なログイン試行（IP/アカウント別）のメトリクスとアラートを用意すること
	- セキュリティ強度：パスワードはArgon2／PBKDF2等の安全なハッシュで保存、TLS 1.2+ を必須化、秘密情報はKMSで管理
	- レート制限と保護：ログイン試行・パスワードリセット等に対するレート制限、ブルートフォース検知と自動ロックアウトポリシー
	- 多要素認証（MFA）：MFAをオプションでサポートし、将来的な強制化に向けた運用設計を行うこと
	- 監査ログ：認証イベント（ログイン成功/失敗、パスワード変更、トークン発行/失効）の詳細ログを保持し、少なくとも1年保持可能にする
	- キー／シークレット管理：トークン署名鍵のローテーション手順と影響範囲のテストを定義すること
	- コンプライアンス：個人情報保護・認証に関する外部規制（Pマーク、個人情報保護法）と内部ポリシーに準拠すること
	- フェイルオーバー：認証依存での全体停止を避けるため、認証ダウン時の最小限のグレースフルハンドリング（例：管理者用の救済手段や限定処理）を定義すること

## 6. ハイレベルデータモデル
- 主要エンティティ：User、Order、OrderLine、SKU、InventoryLocation、InventoryTransaction、Promotion、Shipment
- 注文と在庫は整合性を保つため、注文確定フェーズで在庫ロックIDを発行して追跡する

## 7. インテグレーション要件
- 決済プロバイダ（API経由、トークン方式）
- 3PL/配送業者（出荷指示・追跡・ステータス更新）
- マーケティング基盤（プロモーションスケジュールの受信）
- 会計/ERP（注文確定ステータスのエクスポート）

## 8. 受入基準（受け入れ条件）
- 基本的な注文→在庫引当→出荷指示のシナリオがE2Eで動作すること
- ピーク負荷の簡易負荷試験で主要APIがSLA内で応答すること
- 返品処理フローが管理画面から実行可能であること
- 主要連携（決済・3PL）をステージ環境でシミュレーションできること

## 9. 移行・ローンチ計画（段階）
1. MVP（3ヶ月目標）
	- 基本注文処理、在庫ロック、管理画面の最小機能、決済連携（サンドボックス）
2. v1（6ヶ月目標）
	- プロモーション機能、3PL連携、返品フロー、負荷対策
3. 継続改善フェーズ
	- オムニチャネル拡張、会計連携自動化、さらなる運用改善

## 10. リスクと軽減策
- リスク：セール時の在庫競合でオーバーセルが発生する
  - 軽減策：在庫ロックを速やかに行う、カートの保持期限を短く設定、楽観／悲観ロックの組合せ設計
- リスク：3PL連携の仕様差分で出荷遅延が発生
  - 軽減策：共通APIアダプタ層を挟み、ベンダごとの実装を分離
- リスク：社内承認プロセスでリリース遅延
  - 軽減策：段階リリースとロールバック手順を事前に整備

## 11. 前提・仮定
- 既存の会計システムはCSV/バッチでの受け渡しが可能
- 支払い処理は外部決済サービスを利用し、カード情報は当社で保持しない
- 倉庫側でのオペレーション（ピッキング・受入）には一定の標準化が図られている

## 12. 受け入れテスト（概要）
- ハッピーパス：ユーザーが購入→支払い→在庫引当→出荷指示→配送完了まで
- エッジケース：同一SKUへの同時注文（Nx並列）で在庫不整合が起きないか
- 失敗パス：決済失敗時の在庫ロールバック、返品時の再在庫化

## 13. 技術的制約と推奨アーキテクチャ（高レベル）
- 推奨：ステートレスなREST/gRPC API層、Redis等の高速キャッシュを在庫参照のために利用、RDB（Postgres等）で整合性のあるトランザクションを管理
- 在庫引当：短時間の強整合を必要とするため、分散トランザクションよりもアプリケーション側でのロック設計（例：楽観ロック + 中央化された在庫サービス）を推奨

